<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تحداك — منصة الألعاب الاحترافية</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #6a11cb;
      --primary-dark: #2575fc;
      --secondary: #00c48c;
      --accent: #ffd166;
      --accent-dark: #ffaf3f;
      --bg-dark: #0a0a0a;
      --bg-card: #111111;
      --bg-card-light: #1a1a1a;
      --text: #ffffff;
      --text-light: #bbbbbb;
      --text-muted: #888888;
      --border: rgba(255,255,255,0.06);
      --success: #00c48c;
      --danger: #ff3366;
      --warning: #ffaf3f;
      --admin: #9b5de5;
      --verified: #4cc9f0;
      --overlay-bg: rgba(10, 10, 10, 0.95);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      color: var(--text);
      font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      direction: rtl;
      text-align: right;
      overflow-x: hidden;
      height: 100%;
      position: relative;
    }

    .animated-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background: 
        radial-gradient(circle at 20% 80%, rgba(106, 17, 203, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(37, 117, 252, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(0, 196, 140, 0.1) 0%, transparent 50%),
        linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      animation: bgShift 20s ease-in-out infinite;
    }

    @keyframes bgShift {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .floating-particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }

    .particle {
      position: absolute;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      animation: float 15s infinite linear;
    }

    @keyframes float {
      0% { transform: translateY(100vh) rotate(0deg); }
      100% { transform: translateY(-100px) rotate(360deg); }
    }

    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--overlay-bg);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      backdrop-filter: blur(10px);
    }

    .loader {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--overlay-bg);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(15px);
      animation: fadeIn 0.5s ease-out;
    }

    .login-modal {
      background: linear-gradient(135deg, rgba(17, 17, 17, 0.95), rgba(26, 26, 26, 0.95));
      padding: 40px 30px;
      border-radius: 25px;
      width: 90%;
      max-width: 450px;
      border: 1px solid var(--border);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      text-align: center;
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
    }

    .login-modal::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(106, 17, 203, 0.1), transparent);
      animation: shine 3s infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    header {
      padding: 16px;
      background: rgba(17, 17, 17, 0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(15px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    header h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 1px;
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 800;
    }
    
    main {
      padding: 18px;
      padding-bottom: 110px;
      min-height: calc(100vh - 120px);
      animation: fadeIn 0.5s ease-out;
    }
    
    nav.bottom {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(17, 17, 17, 0.95);
      display: flex;
      justify-content: space-around;
      padding: 12px 6px;
      border-top: 1px solid var(--border);
      z-index: 20;
      backdrop-filter: blur(15px);
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
    }
    
    nav.bottom button {
      background: transparent;
      color: var(--text-light);
      border: 0;
      font-size: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: all 0.3s ease;
    }
    
    nav.bottom button i {
      font-size: 18px;
    }
    
    nav.bottom button.active {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: var(--text);
      box-shadow: 0 6px 20px rgba(106, 17, 203, 0.4);
      transform: translateY(-4px);
    }
    
    section {
      display: none;
      animation: slideUp 0.4s ease-out;
    }
    
    section.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: none; }
    }
    
    .card {
      background: rgba(17, 17, 17, 0.8);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      transition: all 0.4s ease;
      backdrop-filter: blur(10px);
    }
    
    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
    }
    
    .btn {
      display: inline-block;
      padding: 14px 20px;
      border-radius: 14px;
      border: 0;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: var(--text);
      font-weight: 600;
      transition: all 0.3s ease;
      text-align: center;
      box-shadow: 0 6px 20px rgba(106, 17, 203, 0.3);
      font-family: 'Tajawal', sans-serif;
      font-size: 14px;
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(106, 17, 203, 0.5);
    }
    
    .btn.ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-light);
      box-shadow: none;
    }
    
    .btn.ghost:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateY(-3px);
    }
    
    .game-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--overlay-bg);
      z-index: 2000;
      display: none;
      backdrop-filter: blur(15px);
    }
    
    .game-modal {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, rgba(17, 17, 17, 0.95), rgba(26, 26, 26, 0.95));
      width: 95%;
      height: 95%;
      border-radius: 25px;
      border: 1px solid var(--border);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      animation: scaleIn 0.3s ease-out;
    }
    
    @keyframes scaleIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
    
    .game-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(17, 17, 17, 0.8);
    }
    
    .game-content {
      padding: 20px;
      height: calc(100% - 80px);
      overflow-y: auto;
    }
    
    .hero {
      background: linear-gradient(135deg, rgba(106, 17, 203, 0.2), rgba(37, 117, 252, 0.2));
      border-radius: 25px;
      padding: 30px;
      text-align: center;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
    }
    
    .hero-content {
      position: relative;
      z-index: 2;
    }
    
    .hero h2 {
      font-size: 28px;
      margin-bottom: 12px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .profile-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .profile-img-large {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid transparent;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark)) padding-box,
                  linear-gradient(135deg, var(--primary), var(--primary-dark)) border-box;
      box-shadow: 0 8px 25px rgba(106, 17, 203, 0.4);
    }
    
    .profile-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: rgba(26, 26, 26, 0.7);
      padding: 15px;
      border-radius: 15px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      background: rgba(106, 17, 203, 0.1);
    }
    
    .games-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    
    .game-card {
      background: rgba(26, 26, 26, 0.7);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1px solid transparent;
    }
    
    .game-card:hover {
      transform: translateY(-8px);
      border-color: var(--primary);
      box-shadow: 0 10px 30px rgba(106, 17, 203, 0.3);
    }
    
    .game-icon {
      font-size: 40px;
      margin-bottom: 12px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .notification-container {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 350px;
    }
    
    .notification {
      background: linear-gradient(135deg, rgba(17, 17, 17, 0.95), rgba(26, 26, 26, 0.95));
      border-radius: 12px;
      padding: 15px 20px;
      border-left: 4px solid var(--primary);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideInRight 0.3s ease-out;
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
    }
    
    .notification.success {
      border-left-color: var(--success);
    }
    
    .notification.error {
      border-left-color: var(--danger);
    }
    
    .notification.warning {
      border-left-color: var(--warning);
    }
    
    .notification i {
      font-size: 20px;
    }
    
    .notification.success i {
      color: var(--success);
    }
    
    .notification.error i {
      color: var(--danger);
    }
    
    .notification.warning i {
      color: var(--warning);
    }
    
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .confirm-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
      backdrop-filter: blur(10px);
    }
    
    .confirm-modal {
      background: rgba(17, 17, 17, 0.95);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      max-width: 400px;
      width: 90%;
      border: 1px solid var(--border);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    }
    
    @media (min-width: 768px) {
      .games-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .login-modal {
        padding: 50px 40px;
      }
    }
    
    @media (min-width: 1024px) {
      .games-grid {
        grid-template-columns: repeat(4, 1fr);
      }
      
      main {
        max-width: 1200px;
        margin: 0 auto;
      }
      
      nav.bottom {
        width: 1200px;
        left: 50%;
        transform: translateX(-50%);
        border-radius: 20px 20px 0 0;
      }
    }
    
    .xo-board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 20px auto;
      max-width: 300px;
    }
    
    .xo-cell {
      aspect-ratio: 1;
      background: rgba(26, 26, 26, 0.7);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .xo-cell:hover {
      background: rgba(34, 34, 34, 0.8);
      border-color: var(--primary);
    }
    
    .xo-cell.x {
      color: var(--primary);
    }
    
    .xo-cell.o {
      color: var(--secondary);
    }
    
    .xo-rooms-list {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 15px;
    }
    
    .xo-room-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-radius: 12px;
      background: rgba(26, 26, 26, 0.7);
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }
    
    .xo-room-item:hover {
      transform: translateY(-3px);
      background: rgba(34, 34, 34, 0.8);
    }
    
    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }
    
    .quiz-option {
      padding: 15px;
      border-radius: 12px;
      background: rgba(26, 26, 26, 0.7);
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: right;
    }
    
    .quiz-option:hover {
      background: rgba(34, 34, 34, 0.8);
      transform: translateX(-5px);
    }
    
    .quiz-option.correct {
      background: var(--success);
      color: white;
    }
    
    .quiz-option.incorrect {
      background: var(--danger);
      color: white;
    }
    
    .memory-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    
    .memory-card {
      aspect-ratio: 1;
      background: rgba(26, 26, 26, 0.7);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .memory-card.flipped {
      background: var(--primary);
      transform: rotateY(180deg);
    }
    
    .memory-card.matched {
      background: var(--success);
      transform: scale(0.95);
    }
    
    .reaction-box {
      width: 200px;
      height: 200px;
      background: rgba(26, 26, 26, 0.7);
      border-radius: 15px;
      margin: 30px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .reaction-box.active {
      background: var(--primary);
      transform: scale(1.1);
    }
    
    .chat-container {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 300px;
      height: 400px;
      background: rgba(17, 17, 17, 0.95);
      border-radius: 15px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      display: none;
      flex-direction: column;
      z-index: 100;
      backdrop-filter: blur(10px);
    }
    
    .chat-header {
      padding: 15px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .chat-message {
      padding: 10px 15px;
      border-radius: 15px;
      max-width: 80%;
      word-wrap: break-word;
    }
    
    .chat-message.own {
      background: var(--primary);
      align-self: flex-end;
      border-bottom-right-radius: 5px;
    }
    
    .chat-message.other {
      background: rgba(26, 26, 26, 0.7);
      align-self: flex-start;
      border-bottom-left-radius: 5px;
    }
    
    .chat-input {
      padding: 15px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }
    
    .chat-input input {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(10, 10, 10, 0.7);
      color: var(--text);
    }
    
    .quick-messages {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }
    
    .quick-message {
      padding: 5px 10px;
      background: rgba(26, 26, 26, 0.7);
      border-radius: 10px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .quick-message:hover {
      background: var(--primary);
    }
    
    .ai-chat-container {
      position: fixed;
      bottom: 80px;
      left: 20px;
      width: 350px;
      height: 500px;
      background: rgba(17, 17, 17, 0.95);
      border-radius: 15px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      display: none;
      flex-direction: column;
      z-index: 100;
      backdrop-filter: blur(10px);
    }
    
    .ai-chat-header {
      padding: 15px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: 15px 15px 0 0;
    }
    
    .ai-chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .ai-chat-message {
      padding: 10px 15px;
      border-radius: 15px;
      max-width: 85%;
      word-wrap: break-word;
    }
    
    .ai-chat-message.user {
      background: var(--primary);
      align-self: flex-end;
      border-bottom-right-radius: 5px;
    }
    
    .ai-chat-message.ai {
      background: rgba(26, 26, 26, 0.7);
      align-self: flex-start;
      border-bottom-left-radius: 5px;
    }
    
    .ai-chat-input {
      padding: 15px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }
    
    .ai-chat-input input {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(10, 10, 10, 0.7);
      color: var(--text);
    }
    
    .daily-gift-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2500;
      backdrop-filter: blur(10px);
    }
    
    .daily-gift-modal {
      background: linear-gradient(135deg, rgba(17, 17, 17, 0.95), rgba(26, 26, 26, 0.95));
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      max-width: 400px;
      width: 90%;
      border: 1px solid var(--border);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    }
    
    .gift-animation {
      font-size: 80px;
      margin: 20px 0;
      animation: bounce 1s infinite;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    
    .quests-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .quest-card {
      background: rgba(26, 26, 26, 0.7);
      border-radius: 15px;
      padding: 20px;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }
    
    .quest-card:hover {
      transform: translateY(-5px);
      border-color: var(--primary);
    }
    
    .quest-progress {
      height: 8px;
      background: rgba(26, 26, 26, 0.7);
      border-radius: 4px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .quest-progress-bar {
      height: 100%;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body oncontextmenu="return false;" oncopy="return false;" oncut="return false;" onpaste="return false;">
  <div class="animated-bg"></div>
  <div class="floating-particles" id="particles-container"></div>
  
  <div id="loading-screen">
    <div class="loader"></div>
    <h3 style="color: var(--text); margin-bottom: 10px;">جاري التحميل...</h3>
    <p style="color: var(--text-light); text-align: center;">جاري التحقق من حالة المستخدم وتحضير المحتوى</p>
  </div>
  
  <div class="notification-container" id="notification-container"></div>
  
  <div id="login-overlay">
    <div class="login-modal">
      <div style="margin-bottom: 30px;">
        <h2 style="color: var(--text); margin-bottom: 10px;">مرحباً بك في تحداك</h2>
        <p style="color: var(--text-light);">منصة الألعاب العربية المتطورة</p>
      </div>
      
      <div style="margin-bottom: 25px;">
        <div style="width: 120px; height: 120px; border-radius: 50%; background: rgba(255,255,255,0.1); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; cursor: pointer;" id="avatar-upload">
          <i class="fas fa-camera" style="font-size: 30px; color: var(--text-light);"></i>
          <img id="avatar-preview" class="hidden" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
        </div>
        <input type="file" id="avatar-input" accept="image/*" class="hidden">
      </div>
      
      <input type="text" id="login-name" placeholder="اسم المستخدم" style="width: 100%; padding: 15px; border-radius: 12px; border: 1px solid var(--border); background: rgba(10, 10, 10, 0.7); color: var(--text); margin-bottom: 15px; font-size: 16px;">
      
      <button class="btn" id="btn-login" style="width: 100%; padding: 15px; font-size: 16px; margin-bottom: 15px;">
        <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
      </button>
      
      <button class="btn ghost" id="btn-guest-login" style="width: 100%; padding: 15px; font-size: 16px;">
        <i class="fas fa-eye"></i> الدخول كزائر
      </button>
      
      <p style="color: var(--text-muted); margin-top: 20px; font-size: 14px;">الزائر يمكنه الاستكشاف فقط دون المشاركة في الألعاب</p>
    </div>
  </div>
  
  <div class="confirm-overlay" id="logout-confirm">
    <div class="confirm-modal">
      <div style="font-size: 48px; color: var(--warning); margin-bottom: 20px;">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <h3 style="color: var(--text); margin-bottom: 15px;">تأكيد تسجيل الخروج</h3>
      <p style="color: var(--text-light); margin-bottom: 25px;">هل أنت متأكد من رغبتك في تسجيل الخروج؟</p>
      <div style="display: flex; gap: 10px;">
        <button class="btn" id="btn-confirm-logout" style="flex: 1;">نعم، سجل الخروج</button>
        <button class="btn ghost" id="btn-cancel-logout" style="flex: 1;">إلغاء</button>
      </div>
    </div>
  </div>
  
  <div class="game-overlay" id="game-overlay">
    <div class="game-modal">
      <div class="game-header">
        <h3 id="game-title">عنوان اللعبة</h3>
        <button class="btn ghost" id="btn-close-game">
          <i class="fas fa-times"></i> إغلاق
        </button>
      </div>
      <div class="game-content" id="game-content">
      </div>
    </div>
  </div>

  <div class="daily-gift-overlay" id="daily-gift-overlay">
    <div class="daily-gift-modal">
      <div class="gift-animation">🎁</div>
      <h3 style="color: var(--text); margin-bottom: 10px;">هديتك اليومية!</h3>
      <p style="color: var(--text-light); margin-bottom: 20px;">احصل على مكافأة دخولك اليومية</p>
      <div style="font-size: 24px; color: var(--accent); font-weight: 700; margin-bottom: 20px;">
        +15 نقطة<br>+5 عملات
      </div>
      <button class="btn" id="btn-claim-gift">
        <i class="fas fa-gift"></i> استلام الهدية
      </button>
    </div>
  </div>

  <div class="chat-container" id="xo-chat-container">
    <div class="chat-header">
      <h4>محادثة XO</h4>
      <button class="btn ghost small" id="btn-close-xo-chat">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="chat-messages" id="xo-chat-messages">
    </div>
    <div class="chat-input">
      <input type="text" id="xo-chat-input" placeholder="اكتب رسالة...">
      <button class="btn small" id="btn-send-xo-chat"><i class="fas fa-paper-plane"></i></button>
    </div>
    <div class="quick-messages" id="xo-quick-messages">
      <div class="quick-message" onclick="app.sendXoQuickMessage('كفو!')">كفو!</div>
      <div class="quick-message" onclick="app.sendXoQuickMessage('يلا بينا')">يلا بينا</div>
      <div class="quick-message" onclick="app.sendXoQuickMessage('لعبة حلوة')">لعبة حلوة</div>
      <div class="quick-message" onclick="app.sendXoQuickMessage('يلا جولة ثانية')">يلا جولة ثانية</div>
    </div>
  </div>

  <div class="ai-chat-container" id="ai-chat-container">
    <div class="ai-chat-header">
      <h4><i class="fas fa-robot"></i> مساعد تحداك</h4>
      <div>
        <button class="btn ghost small" id="btn-new-ai-chat">
          <i class="fas fa-plus"></i>
        </button>
        <button class="btn ghost small" id="btn-close-ai-chat">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="ai-chat-messages" id="ai-chat-messages">
      <div class="ai-chat-message ai">
        <div style="font-weight: 700;">مساعد تحداك:</div>
        <div>مرحباً! أنا مساعدك في لعبة تحداك. أنا هنا لأجيب على أسئلتك وأساعدك في استكشاف اللعبة. كيف يمكنني مساعدتك اليوم؟</div>
      </div>
    </div>
    <div class="ai-chat-input">
      <input type="text" id="ai-chat-input" placeholder="اسأل مساعد تحداك...">
      <button class="btn small" id="btn-send-ai-chat"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>

  <header>
    <div>
      <h1><i class="fas fa-gamepad"></i> تحداك</h1>
      <div style="font-size:13px;color:var(--text-light);margin-top:4px" id="header-sub">مرحبا بك</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <div id="online-count" style="font-size:14px;color:var(--secondary)"><i class="fas fa-wifi"></i> أونلاين: <span id="online-count-value">0</span></div>
      <button class="btn ghost small" id="btn-sound-toggle"><i class="fas fa-volume-up"></i> صوت</button>
      <button class="btn ghost small" id="btn-logout-header"><i class="fas fa-sign-out-alt"></i> خروج</button>
      <button class="btn ghost small" id="btn-ai-chat"><i class="fas fa-robot"></i> مساعد</button>
    </div>
  </header>

  <main>
    <section id="sec-home" class="active">
      <div class="hero">
        <div class="hero-content">
          <h2>مرحباً <span id="hero-name">ضيف</span></h2>
          <p>استعد للمغامرة! تحدى أصدقائك واربح الجوائز</p>
          <button class="btn pulse" onclick="app.showGameModal('الألعاب', 'events')"><i class="fas fa-play"></i> ابدأ التحدي</button>
        </div>
      </div>

      <div class="card">
        <div class="profile-header">
          <img id="me-photo" class="profile-img-large" src="" alt="صورة" />
          <div style="flex-grow: 1;">
            <div>
              <span id="me-name" style="font-weight:700; font-size: 24px;">ضيف</span>
              <span id="me-verified" class="verified-badge hidden"><i class="fas fa-check-circle"></i></span>
            </div>
            <div style="color:var(--text-muted); margin-top: 5px;">ID: <span id="me-id">0</span> • مستوى: <span id="me-level">0</span></div>
            <div style="color:var(--text-muted);">نقاط: <span id="me-points">0</span></div>
            <div class="badges" id="me-badges" style="margin-top: 10px;"></div>
          </div>
          <div style="text-align: center; background: rgba(26, 26, 26, 0.7); padding: 15px; border-radius: 15px;">
            <div style="color: var(--accent); font-weight: 700; font-size: 24px;" id="me-coins">0</div>
            <div style="font-size: 14px; color: var(--text-muted);"><i class="fas fa-coins"></i> عملات</div>
          </div>
        </div>

        <div class="profile-stats">
          <div class="stat-card">
            <div class="stat-value" id="stat-wins">0</div>
            <div class="stat-label">انتصارات</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-losses">0</div>
            <div class="stat-label">خسائر</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-total">0</div>
            <div class="stat-label">إجمالي</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>المهام اليومية</h3>
        <div class="quests-container" id="daily-quests">
          <!-- المهام اليومية سيتم تحميلها هنا -->
        </div>
      </div>

      <div class="card">
        <h3>الألعاب السريعة</h3>
        <div class="games-grid">
          <div class="game-card" onclick="app.startQuickGame('memory')">
            <div class="game-icon"><i class="fas fa-brain"></i></div>
            <div style="font-weight:700">لعبة الذاكرة</div>
            <div style="color:var(--accent); margin-top: 5px;">+15 نقطة</div>
          </div>
          
          <div class="game-card" onclick="app.startQuickGame('reaction')">
            <div class="game-icon"><i class="fas fa-bolt"></i></div>
            <div style="font-weight:700">سرعة البديهة</div>
            <div style="color:var(--accent); margin-top: 5px;">+10 نقطة</div>
          </div>
          
          <div class="game-card" onclick="app.startQuickGame('math')">
            <div class="game-icon"><i class="fas fa-calculator"></i></div>
            <div style="font-weight:700">تحدي الرياضيات</div>
            <div style="color:var(--accent); margin-top: 5px;">+15 نقطة</div>
          </div>
          
          <div class="game-card" onclick="app.startQuickGame('puzzle')">
            <div class="game-icon"><i class="fas fa-puzzle-piece"></i></div>
            <div style="font-weight:700">الألغاز</div>
            <div style="color:var(--accent); margin-top: 5px;">+12 نقطة</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>الأقسام الرئيسية</h3>
        <div class="games-grid">
          <div class="game-card" onclick="app.showGameModal('الفعاليات', 'events')">
            <div class="game-icon"><i class="fas fa-bullseye"></i></div>
            <div style="font-weight:700">الفعاليات</div>
          </div>
          
          <div class="game-card" onclick="app.showGameModal('المعارك', 'battle')">
            <div class="game-icon"><i class="fas fa-fist-raised"></i></div>
            <div style="font-weight:700">معارك اونلاين</div>
          </div>
          
          <div class="game-card" onclick="app.showXOModal()">
            <div class="game-icon"><i class="fas fa-times"></i></div>
            <div style="font-weight:700">XO اونلاين</div>
          </div>
          
          <div class="game-card" onclick="app.goto('leaderboard')">
            <div class="game-icon"><i class="fas fa-trophy"></i></div>
            <div style="font-weight:700">المتصدرون</div>
          </div>
          
          <div class="game-card" onclick="app.goto('store')">
            <div class="game-icon"><i class="fas fa-shopping-bag"></i></div>
            <div style="font-weight:700">المتجر</div>
          </div>
          
          <div class="game-card" onclick="app.goto('profile')">
            <div class="game-icon"><i class="fas fa-user"></i></div>
            <div style="font-weight:700">ملفي</div>
          </div>
        </div>
      </div>
    </section>

    <section id="sec-leaderboard">
      <div class="card">
        <h2>المتصدرون</h2>
        <div style="display:flex;gap:10px;margin-top:14px">
          <button class="btn small" onclick="app.renderLeaderboard('daily')">اليومي</button>
          <button class="btn small" onclick="app.renderLeaderboard('weekly')">الأسبوعي</button>
          <button class="btn small" onclick="app.renderLeaderboard('all')">كل الأوقات</button>
        </div>
        <div id="leaders-list" style="margin-top:18px"></div>
      </div>
    </section>

    <section id="sec-store">
      <div class="card">
        <h2>المتجر</h2>
        <p style="color:var(--text-light); margin-bottom: 20px;">استخدم عملاتك لشراء عناصر رائعة</p>
        
        <div style="display:flex;align-items:center;gap:10px;margin-top:14px;padding:14px;background:rgba(26,26,26,0.7);border-radius:12px">
          <i class="fas fa-coins" style="color:var(--accent);font-size:24px"></i>
          <div style="flex-grow:1">
            <div style="font-size:13px;color:var(--text-muted)">رصيدك الحالي</div>
            <div style="font-weight:700;color:var(--accent)" id="store-coins">0 عملة</div>
          </div>
        </div>
        
        <div class="games-grid">
          <div class="game-card" onclick="app.buyItem('diamond-frame')">
            <div class="game-icon"><i class="fas fa-gem"></i></div>
            <div style="font-weight:700">إطار الماس</div>
            <div style="color:var(--accent); margin-top: 5px;">50 عملة</div>
            <button class="btn small" style="margin-top: 10px;">شراء</button>
          </div>
          
          <div class="game-card" onclick="app.buyItem('fire-badge')">
            <div class="game-icon"><i class="fas fa-fire"></i></div>
            <div style="font-weight:700">شارة النار</div>
            <div style="color:var(--accent); margin-top: 5px;">30 عملة</div>
            <button class="btn small" style="margin-top: 10px;">شراء</button>
          </div>
          
          <div class="game-card" onclick="app.buyItem('star-bg')">
            <div class="game-icon"><i class="fas fa-star"></i></div>
            <div style="font-weight:700">خلفية النجوم</div>
            <div style="color:var(--accent); margin-top: 5px;">75 عملة</div>
            <button class="btn small" style="margin-top: 10px;">شراء</button>
          </div>
          
          <div class="game-card" onclick="app.buyItem('double-challenge')">
            <div class="game-icon"><i class="fas fa-bolt"></i></div>
            <div style="font-weight:700">تحدي مزدوج</div>
            <div style="color:var(--accent); margin-top: 5px;">40 عملة</div>
            <button class="btn small" style="margin-top: 10px;">شراء</button>
          </div>
          
          <div class="game-card" onclick="app.buyItem('pride-crown')">
            <div class="game-icon"><i class="fas fa-crown"></i></div>
            <div style="font-weight:700">تاج الفخر</div>
            <div style="color:var(--accent); margin-top: 5px;">100 عملة</div>
            <button class="btn small" style="margin-top: 10px;">شراء</button>
          </div>
          
          <div class="game-card" onclick="app.buyItem('protection-shield')">
            <div class="game-icon"><i class="fas fa-shield-alt"></i></div>
            <div style="font-weight:700">درع الحماية</div>
            <div style="color:var(--accent); margin-top: 5px;">60 عملة</div>
            <button class="btn small" style="margin-top: 10px;">شراء</button>
          </div>
        </div>
      </div>
    </section>

    <section id="sec-profile">
      <div class="card">
        <h2>الملف الشخصي</h2>
        <div class="profile-header">
          <div id="profile-frame-container-edit" class="profile-frame">
            <img id="profile-img" class="profile-img-large" src="">
          </div>
          <div style="flex-grow:1">
            <div>
              <span id="profile-username" style="font-weight:800">ضيف</span>
              <span id="profile-verified" class="verified-badge hidden"><i class="fas fa-check-circle"></i></span>
            </div>
            <div style="color:var(--text-light); margin-top: 5px;">ID: <span id="profile-id">0</span> • مستوى: <span id="profile-level">0</span></div>
            <div style="color:var(--text-light);">نقاط: <span id="profile-points">0</span></div>
            <div class="badges" id="profile-badges"></div>
          </div>
          <div style="text-align: center; background: rgba(26, 26, 26, 0.7); padding: 15px; border-radius: 15px;">
            <div style="color: var(--accent); font-weight: 700; font-size: 24px;" id="profile-coins">0</div>
            <div style="font-size: 14px; color: var(--text-muted);"><i class="fas fa-coins"></i> عملات</div>
          </div>
        </div>

        <div style="margin-top:18px">
          <h4>نبذة عني</h4>
          <div id="profile-bio" style="color:var(--text-light); padding:12px; background:rgba(26,26,26,0.7); border-radius:10px; min-height:70px;">
            لا توجد نبذة
          </div>
          <button class="btn small" style="margin-top:10px" id="btn-edit-bio">تعديل النبذة</button>
        </div>

        <div style="margin-top:18px">
          <h4>العناصر المملوكة</h4>
          <div class="badges" id="profile-items">
          </div>
        </div>

        <div style="margin-top:18px">
          <h4>إحصائيات</h4>
          <div class="profile-stats">
            <div class="stat-card">
              <div class="stat-value" id="profile-wins">0</div>
              <div class="stat-label">انتصارات</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="profile-losses">0</div>
              <div class="stat-label">خسائر</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="profile-total">0</div>
              <div class="stat-label">إجمالي</div>
            </div>
          </div>
        </div>

        <div style="margin-top:18px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn" id="btn-edit-profile"><i class="fas fa-edit"></i> تعديل الملف</button>
          <button class="btn ghost" id="btn-copy-id"><i class="fas fa-copy"></i> نسخ المعرف</button>
          <button class="btn" id="btn-logout"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button>
        </div>
      </div>
    </section>
  </main>

  <nav class="bottom">
    <button id="nav-home" class="active" onclick="app.goto('home')">
      <i class="fas fa-home"></i>
      <span>الرئيسية</span>
    </button>
    <button id="nav-events" onclick="app.showGameModal('الفعاليات', 'events')">
      <i class="fas fa-bullseye"></i>
      <span>الفعاليات</span>
    </button>
    <button id="nav-battle" onclick="app.showGameModal('المعارك', 'battle')">
      <i class="fas fa-fist-raised"></i>
      <span>معارك</span>
    </button>
    <button id="nav-profile" onclick="app.goto('profile')">
      <i class="fas fa-user"></i>
      <span>ملفي</span>
    </button>
  </nav>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  
  <script>
    class TahdakApp {
      constructor() {
        this.currentUser = null;
        this.isGuest = false;
        this.soundEnabled = true;
        this.musicEnabled = false;
        this.currentGame = null;
        this.userProgress = {};
        this.xoRooms = {};
        this.currentXORoom = null;
        this.chatMessages = {};
        this.onlineUsers = {};
        this.aiMessages = [];
        this.dailyQuests = [
          { id: 'play-3-games', name: 'العب 3 ألعاب', target: 3, progress: 0, reward: { points: 10, coins: 5 } },
          { id: 'win-2-games', name: 'اربح مباراتين', target: 2, progress: 0, reward: { points: 15, coins: 8 } },
          { id: 'play-xo', name: 'العب XO', target: 1, progress: 0, reward: { points: 8, coins: 3 } },
          { id: 'complete-quiz', name: 'أكمل اختباراً', target: 1, progress: 0, reward: { points: 12, coins: 6 } }
        ];
        this.quizBank = {
          easy: [
            { q: "ما هو لون السماء صافياً؟", choices: ["أخضر", "أزرق", "أحمر", "أسود"], a: 1 },
            { q: "كم عدد أيام الأسبوع؟", choices: ["5", "6", "7", "8"], a: 2 },
            { q: "ما هو أكبر كوكب في النظام الشمسي؟", choices: ["الأرض", "المشتري", "زحل", "المريخ"], a: 1 },
            { q: "ما هي عاصمة مصر؟", choices: ["الرياض", "القاهرة", "دمشق", "بغداد"], a: 1 },
            { q: "كم عدد أركان الإسلام؟", choices: ["4", "5", "6", "7"], a: 1 }
          ],
          medium: [
            { q: "عاصمة اليابان؟", choices: ["بكين", "طوكيو", "سيول", "بانكوك"], a: 1 },
            { q: "كم جانب للمكعب؟", choices: ["4", "6", "8", "12"], a: 1 },
            { q: "ما هو العنصر الكيميائي للرمز 'O'؟", choices: ["ذهب", "فضة", "أكسجين", "أوزميوم"], a: 2 },
            { q: "ما هي أطول رواية في العالم؟", choices: ["البؤساء", "الأوديسة", "حرب السلام", "دون كيشوت"], a: 2 },
            { q: "كم عدد عظام جسم الإنسان؟", choices: ["196", "206", "216", "226"], a: 1 }
          ],
          hard: [
            { q: "ما هو مجموع الزوايا الداخلية لمثلث؟", choices: ["180", "360", "90", "270"], a: 0 },
            { q: "ما هو العدد الأولي التالي بعد 7؟", choices: ["9", "10", "11", "12"], a: 2 },
            { q: "في أي سنة هبط الإنسان على القمر لأول مرة؟", choices: ["1965", "1969", "1972", "1958"], a: 1 },
            { q: "ما هو أسرع حيوان بري؟", choices: ["الفهد", "النمر", "الأسد", "الغزال"], a: 0 },
            { q: "ما هو أعمق محيط في العالم؟", choices: ["المحيط الهندي", "المحيط الهادئ", "المحيط الأطلسي", "المحيط المتجمد الشمالي"], a: 1 }
          ],
          riddles: [
            { q: "إذا كان لديك 3 تفاحات وأخذت 2، كم لديك؟", answer: "2" },
            { q: "ما هو الشيء الذي يملك أسنان لكنه لا يعض؟", answer: "المشط" },
            { q: "ما هو الشيء الذي كلما أخذت منه كبر؟", answer: "الحفرة" },
            { q: "ما هو الشيء الذي نشتريه لكننا لا نراه، وإذا رأيناه لا نستفيد منه؟", answer: "الكفن" },
            { q: "ما هو الشيء الذي يدور حول البيت دون أن يتحرك؟", answer: "الجدار" }
          ],
          logic: [
            { q: "إذا كان أحمد أكبر من محمد بخمس سنوات، ومحمد عمره 10 سنوات، فكم عمر أحمد؟", choices: ["10", "15", "20", "25"], a: 1 },
            { q: "ما هو الرقم التالي في السلسلة: 2, 4, 8, 16, ...؟", choices: ["24", "32", "36", "40"], a: 1 },
            { q: "إذا كان اليوم هو الأربعاء، فما هو اليوم بعد 10 أيام؟", choices: ["السبت", "الأحد", "الاثنين", "الثلاثاء"], a: 0 },
            { q: "إذا كان لديك 5 تفاحات وأعطيت صديقك 2، واشتريت 3 إضافية، فكم لديك؟", choices: ["4", "5", "6", "7"], a: 2 },
            { q: "ما هو الشيء الذي لا يمكنك استخدامه إلا بعد كسره؟", choices: ["البيضة", "القلم", "الزجاج", "الخشب"], a: 0 }
          ],
          words: [
            { q: "ما هي الكلمة التي يمكن قراءتها بشكل مقلوب دون تغيير؟", choices: ["ماء", "أب", "توت", "كلها"], a: 2 },
            { q: "ما هو عكس كلمة 'كبير'؟", choices: ["صغير", "طويل", "قصير", "ضخم"], a: 0 },
            { q: "ما هي الكلمة التي تبدأ بحرف 'أ' وتنتهي بحرف 'ل'؟", choices: ["أرجل", "أمل", "أهل", "كلها"], a: 3 },
            { q: "ما هو جمع كلمة 'كتاب'؟", choices: ["كتب", "كتابات", "كتابان", "كلها"], a: 0 },
            { q: "ما هو مرادف كلمة 'جميل'؟", choices: ["حسن", "قبيح", "طويل", "قصير"], a: 0 }
          ],
          colors: [
            { q: "ما هو اللون الناتج من مزج الأحمر والأزرق؟", choices: ["أخضر", "بنفسجي", "برتقالي", "أصفر"], a: 1 },
            { q: "ما هو اللون الأساسي؟", choices: ["أحمر", "أخضر", "بنفسجي", "كلها"], a: 0 },
            { q: "ما هو اللون المكمل للأحمر؟", choices: ["أزرق", "أخضر", "أصفر", "بنفسجي"], a: 1 },
            { q: "ما هو لون البحر؟", choices: ["أزرق", "أخضر", "كلاهما", "لا شيء"], a: 2 },
            { q: "ما هو لون الدم؟", choices: ["أحمر", "أزرق", "أخضر", "أصفر"], a: 0 }
          ]
        };
        this.init();
      }
      
      init() {
        this.initFirebase();
        this.setupEventListeners();
        this.createParticles();
        this.checkUserSession();
        this.initAI();
      }
      
      initFirebase() {
        const firebaseConfig = {
          apiKey: "AIzaSyB3crsDcJI1qYipy6awM6VIoAamLC51zi4",
          authDomain: "cinmanryo.firebaseapp.com",
          databaseURL: "https://cinmanryo-default-rtdb.firebaseio.com",
          projectId: "cinmanryo",
          storageBucket: "cinmanryo.appspot.com",
          messagingSenderId: "605207743179",
          appId: "1:605207743179:web:0bb0b6efdd208e9094a94e",
          measurementId: "G-SH32EZ7ZY6"
        };
        
        firebase.initializeApp(firebaseConfig);
        this.db = firebase.database();
        this.storage = firebase.storage();
      }
      
      setupEventListeners() {
        document.getElementById('btn-login').addEventListener('click', () => this.login());
        document.getElementById('btn-guest-login').addEventListener('click', () => this.loginAsGuest());
        document.getElementById('avatar-upload').addEventListener('click', () => document.getElementById('avatar-input').click());
        document.getElementById('avatar-input').addEventListener('change', (e) => this.handleAvatarUpload(e));
        document.getElementById('btn-sound-toggle').addEventListener('click', () => this.toggleSound());
        document.getElementById('btn-logout-header').addEventListener('click', () => this.showLogoutConfirm());
        document.getElementById('btn-confirm-logout').addEventListener('click', () => this.logout());
        document.getElementById('btn-cancel-logout').addEventListener('click', () => this.hideLogoutConfirm());
        document.getElementById('btn-close-game').addEventListener('click', () => this.closeGameModal());
        document.getElementById('btn-close-xo-chat').addEventListener('click', () => this.closeXOChat());
        document.getElementById('btn-send-xo-chat').addEventListener('click', () => this.sendXOChatMessage());
        document.getElementById('xo-chat-input').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') this.sendXOChatMessage();
        });
        document.getElementById('btn-edit-bio').addEventListener('click', () => this.editBio());
        document.getElementById('btn-edit-profile').addEventListener('click', () => this.editProfile());
        document.getElementById('btn-copy-id').addEventListener('click', () => this.copyUserId());
        document.getElementById('btn-logout').addEventListener('click', () => this.showLogoutConfirm());
        document.getElementById('btn-ai-chat').addEventListener('click', () => this.toggleAIChat());
        document.getElementById('btn-close-ai-chat').addEventListener('click', () => this.closeAIChat());
        document.getElementById('btn-new-ai-chat').addEventListener('click', () => this.newAIChat());
        document.getElementById('btn-send-ai-chat').addEventListener('click', () => this.sendAIMessage());
        document.getElementById('ai-chat-input').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') this.sendAIMessage();
        });
        document.getElementById('btn-claim-gift').addEventListener('click', () => this.claimDailyGift());
      }
      
      createParticles() {
        const container = document.getElementById('particles-container');
        for (let i = 0; i < 20; i++) {
          const particle = document.createElement('div');
          particle.className = 'particle';
          particle.style.width = `${Math.random() * 10 + 5}px`;
          particle.style.height = particle.style.width;
          particle.style.left = `${Math.random() * 100}%`;
          particle.style.animationDelay = `${Math.random() * 15}s`;
          particle.style.animationDuration = `${Math.random() * 10 + 10}s`;
          container.appendChild(particle);
        }
      }
      
      async checkUserSession() {
        const savedUser = localStorage.getItem('tahdak_user');
        
        if (savedUser) {
          const userData = JSON.parse(savedUser);
          await this.loadUserData(userData.name);
        } else {
          setTimeout(() => {
            document.getElementById('loading-screen').style.display = 'none';
          }, 2000);
        }
      }
      
      async login() {
        const name = document.getElementById('login-name').value.trim();
        const avatarFile = document.getElementById('avatar-input').files[0];
        
        if (!name) {
          this.showNotification('يرجى إدخال اسم المستخدم', 'error');
          return;
        }
        
        this.showLoading('جاري تسجيل الدخول...');
        
        try {
          let avatarUrl = '';
          
          if (avatarFile) {
            avatarUrl = await this.uploadAvatar(avatarFile);
          } else {
            avatarUrl = this.generateDefaultAvatar(name);
          }
          
          const userId = await this.generateUserId();
          const userData = {
            id: userId,
            name: name,
            photo: avatarUrl,
            bio: '',
            points: 0,
            coins: 5,
            wins: 0,
            losses: 0,
            level: 1,
            badges: ['مبتدئ'],
            items: [],
            verified: false,
            lastLogin: Date.now(),
            joinDate: Date.now(),
            lastDailyGift: 0,
            quests: {}
          };
          
          await this.saveUserData(name, userData);
          this.currentUser = userData;
          this.isGuest = false;
          
          localStorage.setItem('tahdak_user', JSON.stringify({ name: name, photo: avatarUrl }));
          this.afterLogin();
          
        } catch (error) {
          console.error('Login error:', error);
          this.showNotification('حدث خطأ في تسجيل الدخول', 'error');
          this.hideLoading();
        }
      }
      
      async loginAsGuest() {
        this.currentUser = {
          id: 0,
          name: 'زائر',
          photo: this.generateDefaultAvatar('زائر'),
          points: 0,
          coins: 0,
          wins: 0,
          losses: 0,
          level: 1,
          badges: [],
          items: [],
          isGuest: true
        };
        
        this.isGuest = true;
        this.afterLogin();
      }
      
      afterLogin() {
        this.hideLoading();
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('loading-screen').style.display = 'none';
        
        this.updateUI();
        this.showNotification(`مرحباً ${this.currentUser.name} في تحداك!`, 'success');
        
        if (!this.isGuest) {
          this.setupPresence();
          this.setupXOListeners();
          this.setupOnlineUsersListener();
          this.checkDailyGift();
          this.loadDailyQuests();
        }
      }
      
      updateUI() {
        if (!this.currentUser) return;
        
        document.getElementById('hero-name').textContent = this.currentUser.name;
        document.getElementById('me-name').textContent = this.currentUser.name;
        document.getElementById('me-photo').src = this.currentUser.photo;
        document.getElementById('me-id').textContent = this.currentUser.id;
        document.getElementById('me-points').textContent = this.currentUser.points;
        document.getElementById('me-level').textContent = this.currentUser.level;
        document.getElementById('me-coins').textContent = this.currentUser.coins;
        
        document.getElementById('stat-wins').textContent = this.currentUser.wins;
        document.getElementById('stat-losses').textContent = this.currentUser.losses;
        document.getElementById('stat-total').textContent = this.currentUser.wins + this.currentUser.losses;
        
        document.getElementById('profile-img').src = this.currentUser.photo;
        document.getElementById('profile-username').textContent = this.currentUser.name;
        document.getElementById('profile-id').textContent = this.currentUser.id;
        document.getElementById('profile-points').textContent = this.currentUser.points;
        document.getElementById('profile-level').textContent = this.currentUser.level;
        document.getElementById('profile-coins').textContent = this.currentUser.coins;
        document.getElementById('profile-bio').textContent = this.currentUser.bio || 'لا توجد نبذة';
        
        document.getElementById('profile-wins').textContent = this.currentUser.wins;
        document.getElementById('profile-losses').textContent = this.currentUser.losses;
        document.getElementById('profile-total').textContent = this.currentUser.wins + this.currentUser.losses;
        
        document.getElementById('store-coins').textContent = `${this.currentUser.coins} عملة`;
        
        const guestElements = document.querySelectorAll('.guest-restricted');
        guestElements.forEach(el => {
          el.style.display = this.isGuest ? 'none' : 'block';
        });
        
        this.renderBadges();
        this.renderOwnedItems();
      }
      
      async loadUserData(username) {
        try {
          const snapshot = await this.db.ref('users/' + username).once('value');
          const userData = snapshot.val();
          
          if (userData) {
            this.currentUser = userData;
            this.isGuest = false;
            this.afterLogin();
          } else {
            document.getElementById('loading-screen').style.display = 'none';
          }
        } catch (error) {
          console.error('Error loading user:', error);
          document.getElementById('loading-screen').style.display = 'none';
        }
      }
      
      async saveUserData(username, userData) {
        await this.db.ref('users/' + username).set(userData);
      }
      
      async uploadAvatar(file) {
        const ref = this.storage.ref('avatars/' + Date.now() + '_' + file.name);
        const snapshot = await ref.put(file);
        return await snapshot.ref.getDownloadURL();
      }
      
      generateDefaultAvatar(name) {
        const initials = name.substring(0, 2);
        const colors = ['#6a11cb', '#2575fc', '#00c48c', '#ff3366', '#ffd166'];
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        return `data:image/svg+xml;utf8,${encodeURIComponent(`
          <svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'>
            <rect fill='${color}' width='100%' height='100%'/>
            <text x='50%' y='50%' fill='#fff' font-size='80' text-anchor='middle' dominant-baseline='central'>${initials}</text>
          </svg>
        `)}`;
      }
      
      async generateUserId() {
        let id;
        let isUnique = false;
        
        while (!isUnique) {
          id = Math.floor(Math.random() * 9000) + 1000;
          const snapshot = await this.db.ref('users').orderByChild('id').equalTo(id).once('value');
          isUnique = !snapshot.exists();
        }
        
        return id;
      }
      
      generateRoomId() {
        return Math.floor(100000 + Math.random() * 900000);
      }
      
      handleAvatarUpload(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            document.getElementById('avatar-preview').src = e.target.result;
            document.getElementById('avatar-preview').classList.remove('hidden');
            document.querySelector('#avatar-upload i').classList.add('hidden');
          };
          reader.readAsDataURL(file);
        }
      }
      
      goto(section) {
        document.querySelectorAll('section').forEach(sec => {
          sec.classList.remove('active');
        });
        
        document.getElementById(`sec-${section}`).classList.add('active');
        
        document.querySelectorAll('nav.bottom button').forEach(button => {
          button.classList.remove('active');
        });
        
        document.getElementById(`nav-${section}`).classList.add('active');
        
        if (section === 'leaderboard') {
          this.renderLeaderboard('all');
        } else if (section === 'profile') {
          this.updateUI();
        } else if (section === 'store') {
          this.updateUI();
        }
      }
      
      showGameModal(title, type) {
        if (this.isGuest && type !== 'events') {
          this.showNotification('الزائر لا يمكنه المشاركة في الألعاب', 'warning');
          return;
        }
        
        document.getElementById('game-title').textContent = title;
        document.getElementById('game-overlay').style.display = 'block';
        
        this.loadGameContent(type);
      }
      
      closeGameModal() {
        document.getElementById('game-overlay').style.display = 'none';
        document.getElementById('game-content').innerHTML = '';
        
        if (this.currentGame) {
          this.currentGame = null;
        }
        
        if (this.currentXORoom) {
          this.leaveXORoom();
        }
      }
      
      loadGameContent(type) {
        const content = document.getElementById('game-content');
        
        switch(type) {
          case 'events':
            content.innerHTML = this.getEventsContent();
            break;
          case 'battle':
            content.innerHTML = this.getBattleContent();
            break;
          default:
            content.innerHTML = '<p>جاري تحميل المحتوى...</p>';
        }
      }
      
      getEventsContent() {
        return `
          <div style="text-align: center; padding: 20px;">
            <h3 style="color: var(--primary); margin-bottom: 20px;">الفعاليات والتحديات</h3>
            <div class="games-grid">
              <div class="game-card" onclick="app.startQuiz('easy')">
                <div class="game-icon"><i class="fas fa-brain"></i></div>
                <div style="font-weight:700">أسئلة سهلة</div>
                <div style="color:var(--accent); margin-top: 5px;">+5 نقاط</div>
              </div>
              
              <div class="game-card" onclick="app.startQuiz('medium')">
                <div class="game-icon"><i class="fas fa-puzzle-piece"></i></div>
                <div style="font-weight:700">أسئلة متوسطة</div>
                <div style="color:var(--accent); margin-top: 5px;">+10 نقاط</div>
              </div>
              
              <div class="game-card" onclick="app.startQuiz('hard')">
                <div class="game-icon"><i class="fas fa-crown"></i></div>
                <div style="font-weight:700">أسئلة صعبة</div>
                <div style="color:var(--accent); margin-top: 5px;">+20 نقاط</div>
              </div>
              
              <div class="game-card" onclick="app.startRiddle()">
                <div class="game-icon"><i class="fas fa-question-circle"></i></div>
                <div style="font-weight:700">ألغاز رياضية</div>
                <div style="color:var(--accent); margin-top: 5px;">+10 نقاط</div>
              </div>
              
              <div class="game-card" onclick="app.startLogicChallenge()">
                <div class="game-icon"><i class="fas fa-chess"></i></div>
                <div style="font-weight:700">تحدي المنطق</div>
                <div style="color:var(--accent); margin-top: 5px;">+12 نقاط</div>
              </div>
              
              <div class="game-card" onclick="app.startWordChallenge()">
                <div class="game-icon"><i class="fas fa-font"></i></div>
                <div style="font-weight:700">تحدي الكلمات</div>
                <div style="color:var(--accent); margin-top: 5px;">+8 نقاط</div>
              </div>
              
              <div class="game-card" onclick="app.startColorChallenge()">
                <div class="game-icon"><i class="fas fa-palette"></i></div>
                <div style="font-weight:700">تحدي الألوان</div>
                <div style="color:var(--accent); margin-top: 5px;">+10 نقاط</div>
              </div>
            </div>
          </div>
        `;
      }
      
      getBattleContent() {
        return `
          <div style="text-align: center; padding: 20px;">
            <h3 style="color: var(--primary); margin-bottom: 20px;">معارك اونلاين</h3>
            <p style="color: var(--text-light); margin-bottom: 30px;">تحدى لاعبين آخرين في معارك مباشرة!</p>
            
            <div class="games-grid">
              <div class="game-card" onclick="app.startBattleMemory()">
                <div class="game-icon"><i class="fas fa-brain"></i></div>
                <div style="font-weight:700">ذاكرة تنافسية</div>
                <div style="color:var(--accent); margin-top: 5px;">+20 نقطة</div>
              </div>
              
              <div class="game-card" onclick="app.startBattleReaction()">
                <div class="game-icon"><i class="fas fa-bolt"></i></div>
                <div style="font-weight:700">سرعة البديهة</div>
                <div style="color:var(--accent); margin-top: 5px;">+15 نقطة</div>
              </div>
              
              <div class="game-card" onclick="app.startBattleMath()">
                <div class="game-icon"><i class="fas fa-calculator"></i></div>
                <div style="font-weight:700">تحدي الرياضيات</div>
                <div style="color:var(--accent); margin-top: 5px;">+25 نقطة</div>
              </div>
            </div>
          </div>
        `;
      }
      
      showXOModal() {
        if (this.isGuest) {
          this.showNotification('الزائر لا يمكنه المشاركة في الألعاب', 'warning');
          return;
        }
        
        document.getElementById('game-title').textContent = 'XO اونلاين';
        document.getElementById('game-overlay').style.display = 'block';
        
        document.getElementById('game-content').innerHTML = `
          <div style="padding: 20px;">
            <h3 style="color: var(--primary); margin-bottom: 20px; text-align: center;">لعبة XO اونلاين</h3>
            
            <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 30px;">
              <button class="btn" onclick="app.createXORoom()">إنشاء غرفة</button>
              <button class="btn secondary" onclick="app.showXORooms()">استعراض الغرف</button>
            </div>
            
            <div style="margin-bottom: 20px;">
              <input type="text" id="xo-search" placeholder="ابحث برقم الغرفة..." style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: rgba(10, 10, 10, 0.7); color: var(--text);">
              <button class="btn small" onclick="app.searchXORoom()" style="margin-top: 10px; width: 100%;">بحث</button>
            </div>
            
            <div id="xo-rooms-container">
            </div>
            
            <div id="xo-game-container" class="hidden">
            </div>
          </div>
        `;
        
        this.showXORooms();
      }
      
      setupXOListeners() {
        if (this.isGuest) return;
        
        this.db.ref('xoRooms').on('value', (snapshot) => {
          this.xoRooms = snapshot.val() || {};
          this.renderXORooms();
        });
      }
      
      setupOnlineUsersListener() {
        this.db.ref('onlineUsers').on('value', (snapshot) => {
          this.onlineUsers = snapshot.val() || {};
          const onlineCount = Object.values(this.onlineUsers).filter(user => user.online).length;
          document.getElementById('online-count-value').textContent = onlineCount;
        });
      }
      
      setupPresence() {
        if (this.isGuest || !this.currentUser) return;
        
        const userRef = this.db.ref('onlineUsers/' + this.currentUser.name);
        
        userRef.set({
          online: true,
          lastActive: Date.now(),
          name: this.currentUser.name,
          photo: this.currentUser.photo
        });
        
        userRef.onDisconnect().set({
          online: false,
          lastActive: Date.now()
        });
        
        setInterval(() => {
          userRef.update({
            online: true,
            lastActive: Date.now()
          });
        }, 30000);
      }
      
      async createXORoom() {
        if (this.isGuest) {
          this.showNotification('الزائر لا يمكنه إنشاء غرف', 'warning');
          return;
        }
        
        const roomId = this.generateRoomId();
        const roomData = {
          id: roomId,
          host: this.currentUser.name,
          hostPhoto: this.currentUser.photo,
          players: [this.currentUser.name],
          board: ['', '', '', '', '', '', '', '', ''],
          currentPlayer: 'X',
          status: 'waiting',
          winner: null,
          createdAt: Date.now(),
          expiresAt: Date.now() + 300000
        };
        
        await this.db.ref('xoRooms/' + roomId).set(roomData);
        this.showNotification(`تم إنشاء غرفة XO برقم ${roomId}`, 'success');
        
        this.joinXORoom(roomId);
      }
      
      showXORooms() {
        const container = document.getElementById('xo-rooms-container');
        container.innerHTML = '<h4 style="margin-bottom: 15px; text-align: center;">غرف XO المتاحة</h4>';
        
        if (Object.keys(this.xoRooms).length === 0) {
          container.innerHTML += '<p style="text-align: center; color: var(--text-muted);">لا توجد غرف متاحة حالياً</p>';
          return;
        }
        
        const roomsList = Object.values(this.xoRooms)
          .filter(room => room.status === 'waiting' && room.expiresAt > Date.now())
          .sort((a, b) => b.createdAt - a.createdAt);
        
        if (roomsList.length === 0) {
          container.innerHTML += '<p style="text-align: center; color: var(--text-muted);">لا توجد غرف متاحة حالياً</p>';
          return;
        }
        
        roomsList.forEach(room => {
          const roomElement = document.createElement('div');
          roomElement.className = 'xo-room-item';
          roomElement.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
              <img src="${room.hostPhoto}" style="width: 40px; height: 40px; border-radius: 50%;">
              <div>
                <div style="font-weight: 700;">غرفة ${room.host}</div>
                <div style="color: var(--text-muted); font-size: 12px;">رقم: ${room.id}</div>
              </div>
            </div>
            <div>
              <button class="btn small" onclick="app.joinXORoom(${room.id})">انضم</button>
              <button class="btn ghost small" onclick="app.copyRoomId(${room.id})" style="margin-right: 5px;">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          `;
          container.appendChild(roomElement);
        });
      }
      
      renderXORooms() {
        if (document.getElementById('xo-rooms-container').innerHTML.includes('غرف XO المتاحة')) {
          this.showXORooms();
        }
      }
      
      async searchXORoom() {
        const searchId = parseInt(document.getElementById('xo-search').value);
        
        if (!searchId || isNaN(searchId)) {
          this.showNotification('يرجى إدخال رقم غرفة صحيح', 'error');
          return;
        }
        
        const room = this.xoRooms[searchId];
        
        if (!room) {
          this.showNotification('لم يتم العثور على غرفة بهذا الرقم', 'error');
          return;
        }
        
        if (room.status !== 'waiting') {
          this.showNotification('هذه الغرفة ليست متاحة للانضمام', 'warning');
          return;
        }
        
        if (room.expiresAt <= Date.now()) {
          this.showNotification('انتهت صلاحية هذه الغرفة', 'warning');
          return;
        }
        
        this.joinXORoom(searchId);
      }
      
      async joinXORoom(roomId) {
        if (this.isGuest) {
          this.showNotification('الزائر لا يمكنه الانضمام للغرف', 'warning');
          return;
        }
        
        const room = this.xoRooms[roomId];
        
        if (!room) {
          this.showNotification('الغرفة لم تعد موجودة', 'error');
          return;
        }
        
        if (room.players.includes(this.currentUser.name)) {
          this.showXOGame(roomId);
          return;
        }
        
        if (room.players.length >= 2) {
          this.showNotification('الغرفة ممتلئة', 'warning');
          return;
        }
        
        if (room.status !== 'waiting') {
          this.showNotification('لا يمكن الانضمام لهذه الغرفة', 'warning');
          return;
        }
        
        const updatedPlayers = [...room.players, this.currentUser.name];
        await this.db.ref('xoRooms/' + roomId).update({
          players: updatedPlayers,
          status: updatedPlayers.length === 2 ? 'playing' : 'waiting'
        });
        
        this.showNotification('تم الانضمام للغرفة بنجاح', 'success');
        this.showXOGame(roomId);
      }
      
      showXOGame(roomId) {
        this.currentXORoom = roomId;
        document.getElementById('xo-rooms-container').classList.add('hidden');
        document.getElementById('xo-game-container').classList.remove('hidden');
        
        this.renderXOGame(roomId);
        
        this.db.ref('xoRooms/' + roomId).on('value', (snapshot) => {
          const room = snapshot.val();
          if (!room) {
            this.showNotification('تم إغلاق الغرفة', 'warning');
            this.leaveXORoom();
            return;
          }
          
          this.renderXOGame(roomId);
        });
        
        this.setupXOChat(roomId);
        this.showXOChat();
      }
      
      renderXOGame(roomId) {
        const room = this.xoRooms[roomId];
        if (!room) return;
        
        const container = document.getElementById('xo-game-container');
        const playerIndex = room.players.indexOf(this.currentUser.name);
        const playerSymbol = playerIndex === 0 ? 'X' : 'O';
        
        container.innerHTML = `
          <div style="text-align: center;">
            <h4>غرفة ${room.host} - الرقم: ${room.id}</h4>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <img src="${room.hostPhoto}" style="width: 40px; height: 40px; border-radius: 50%;">
                <span style="font-weight: 700; color: ${room.currentPlayer === 'X' ? 'var(--primary)' : 'var(--text-muted)'};">${room.host} (X)</span>
              </div>
              
              <div style="font-weight: 700; color: var(--accent);">VS</div>
              
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-weight: 700; color: ${room.currentPlayer === 'O' ? 'var(--secondary)' : 'var(--text-muted)'};">${room.players[1] || 'بانتظار لاعب...'} (O)</span>
                ${room.players[1] ? `<img src="${this.getPlayerPhoto(room.players[1])}" style="width: 40px; height: 40px; border-radius: 50%;">` : ''}
              </div>
            </div>
            
            ${room.status === 'finished' ? `
              <div style="text-align: center; margin: 15px 0; padding: 10px; background: var(--bg-card-light); border-radius: 10px;">
                <h4>${room.winner ? `فاز ${room.winner === 'X' ? room.host : room.players[1]}!` : 'تعادل!'}</h4>
                ${room.host === this.currentUser.name && room.players.length === 2 ? `
                  <button class="btn" onclick="app.rematchXOGame(${roomId})" style="margin-top: 10px;">العب مرة أخرى</button>
                ` : ''}
              </div>
            ` : ''}
            
            <div class="xo-board">
              ${room.board.map((cell, index) => `
                <div class="xo-cell ${cell ? (cell === 'X' ? 'x' : 'o') : ''}" 
                     onclick="app.makeXOMove(${index})"
                     style="${room.status !== 'playing' || room.currentPlayer !== playerSymbol || cell ? 'pointer-events: none;' : ''}">
                  ${cell === 'X' ? '<i class="fas fa-times"></i>' : cell === 'O' ? '<i class="far fa-circle"></i>' : ''}
                </div>
              `).join('')}
            </div>
            
            <div style="margin-top: 20px;">
              <div style="color: var(--text-muted); margin-bottom: 10px;">
                ${room.status === 'waiting' ? 'بانتظار لاعب آخر...' : 
                  room.status === 'playing' ? `دور ${room.currentPlayer === 'X' ? room.host : room.players[1]}` : ''}
              </div>
              <button class="btn ghost" onclick="app.leaveXORoom()">مغادرة الغرفة</button>
              <button class="btn ghost" onclick="app.toggleXOChat()" style="margin-right: 10px;">
                <i class="fas fa-comments"></i> محادثة
              </button>
            </div>
          </div>
        `;
      }
      
      async makeXOMove(cellIndex) {
        if (!this.currentXORoom) return;
        
        const room = this.xoRooms[this.currentXORoom];
        if (!room || room.status !== 'playing') return;
        
        const playerIndex = room.players.indexOf(this.currentUser.name);
        const playerSymbol = playerIndex === 0 ? 'X' : 'O';
        
        if (room.currentPlayer !== playerSymbol) return;
        if (room.board[cellIndex] !== '') return;
        
        const newBoard = [...room.board];
        newBoard[cellIndex] = playerSymbol;
        
        const winner = this.checkXOWinner(newBoard);
        const isBoardFull = newBoard.every(cell => cell !== '');
        
        const updates = {
          board: newBoard,
          currentPlayer: playerSymbol === 'X' ? 'O' : 'X'
        };
        
        if (winner) {
          updates.status = 'finished';
          updates.winner = winner;
          
          this.addPoints(room.players[playerIndex], 10, 'xo-win');
          this.addCoins(room.players[playerIndex], 15, 'xo-win');
          
          this.showNotification(`مبروك! فزت في لعبة XO وربحت 10 نقاط و 15 عملة`, 'success');
          
          setTimeout(() => {
            this.db.ref('xoRooms/' + this.currentXORoom).remove();
            this.db.ref('xoChat/' + this.currentXORoom).remove();
          }, 10000);
        } else if (isBoardFull) {
          updates.status = 'finished';
          updates.winner = null;
          
          room.players.forEach(player => {
            this.addPoints(player, 5, 'xo-draw');
            this.addCoins(player, 5, 'xo-draw');
          });
          
          this.showNotification('تعادل! كسبت 5 نقاط و 5 عملات', 'success');
          
          setTimeout(() => {
            this.db.ref('xoRooms/' + this.currentXORoom).remove();
            this.db.ref('xoChat/' + this.currentXORoom).remove();
          }, 10000);
        }
        
        await this.db.ref('xoRooms/' + this.currentXORoom).update(updates);
      }
      
      async rematchXOGame(roomId) {
        const room = this.xoRooms[roomId];
        if (!room) return;
        
        const newRoomId = this.generateRoomId();
        const newRoomData = {
          id: newRoomId,
          host: room.host,
          hostPhoto: room.hostPhoto,
          players: room.players,
          board: ['', '', '', '', '', '', '', '', ''],
          currentPlayer: 'X',
          status: 'waiting',
          winner: null,
          createdAt: Date.now(),
          expiresAt: Date.now() + 300000
        };
        
        await this.db.ref('xoRooms/' + newRoomId).set(newRoomData);
        
        this.db.ref('xoChat/' + roomId).remove();
        
        this.showNotification('تم إنشاء غرفة جديدة!', 'success');
        this.joinXORoom(newRoomId);
      }
      
      checkXOWinner(board) {
        const winPatterns = [
          [0, 1, 2], [3, 4, 5], [6, 7, 8],
          [0, 3, 6], [1, 4, 7], [2, 5, 8],
          [0, 4, 8], [2, 4, 6]
        ];
        
        for (const pattern of winPatterns) {
          const [a, b, c] = pattern;
          if (board[a] && board[a] === board[b] && board[a] === board[c]) {
            return board[a];
          }
        }
        
        return null;
      }
      
      leaveXORoom() {
        if (this.currentXORoom) {
          this.db.ref('xoRooms/' + this.currentXORoom).off();
          this.db.ref('xoChat/' + this.currentXORoom).off();
          this.currentXORoom = null;
        }
        
        document.getElementById('xo-rooms-container').classList.remove('hidden');
        document.getElementById('xo-game-container').classList.add('hidden');
        document.getElementById('xo-rooms-container').innerHTML = '';
        
        this.showXORooms();
        this.closeXOChat();
      }
      
      copyRoomId(roomId) {
        navigator.clipboard.writeText(roomId.toString())
          .then(() => {
            this.showNotification('تم نسخ رقم الغرفة', 'success');
          })
          .catch(err => {
            this.showNotification('فشل في نسخ الرقم', 'error');
          });
      }
      
      getPlayerPhoto(playerName) {
        return this.generateDefaultAvatar(playerName);
      }
      
      setupXOChat(roomId) {
        this.db.ref('xoChat/' + roomId).on('value', (snapshot) => {
          const messages = snapshot.val() || {};
          this.renderXOChat(messages);
        });
      }
      
      renderXOChat(messages) {
        const container = document.getElementById('xo-chat-messages');
        container.innerHTML = '';
        
        Object.values(messages).forEach(message => {
          const messageElement = document.createElement('div');
          messageElement.className = `chat-message ${message.sender === this.currentUser.name ? 'own' : 'other'}`;
          messageElement.innerHTML = `
            <div style="font-weight: 700; font-size: 12px;">${message.sender}</div>
            <div>${message.text}</div>
            <div style="font-size: 10px; opacity: 0.7;">${new Date(message.timestamp).toLocaleTimeString()}</div>
          `;
          container.appendChild(messageElement);
        });
        
        container.scrollTop = container.scrollHeight;
      }
      
      showXOChat() {
        document.getElementById('xo-chat-container').style.display = 'flex';
      }
      
      closeXOChat() {
        document.getElementById('xo-chat-container').style.display = 'none';
      }
      
      toggleXOChat() {
        const chat = document.getElementById('xo-chat-container');
        chat.style.display = chat.style.display === 'flex' ? 'none' : 'flex';
      }
      
      sendXOChatMessage() {
        if (!this.currentXORoom) return;
        
        const input = document.getElementById('xo-chat-input');
        const text = input.value.trim();
        
        if (!text) return;
        
        this.db.ref('xoChat/' + this.currentXORoom).push({
          sender: this.currentUser.name,
          text: text,
          timestamp: Date.now()
        });
        
        input.value = '';
      }
      
      sendXoQuickMessage(text) {
        if (!this.currentXORoom) return;
        
        this.db.ref('xoChat/' + this.currentXORoom).push({
          sender: this.currentUser.name,
          text: text,
          timestamp: Date.now()
        });
      }
      
      // نظام الذكاء الاصطناعي
      initAI() {
        this.aiMessages = [
          { role: "system", content: `أنت الآن تمثل شخصية من لعبة "تحداك".
شخصية ذكية، ساخرة أحياناً، تحب أن تختبر قدرات اللاعب،
وتتكلم بنبرة متحدية ومشوقة.
اجعل ردودك مليئة بالتحدي والإثارة، لكن لا تخرج عن كونك شخصية من اللعبة.
قدّم نفسك وكأنك خصم اللاعب في اللعبة، وادعُه دوماً لإثبات نفسه.` }
        ];
      }
      
      async sendToAI(userMessage) {
        this.aiMessages.push({ role: "user", content: userMessage });

        try {
          const res = await fetch("https://grok.free/wp-admin/admin-ajax.php?action=yescale_chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: "gpt-4o-mini",
              messages: this.aiMessages,
              max_tokens: 500,
              temperature: 0.7,
              stream: false
            })
          });

          const data = await res.json();
          const botReply = data.choices[0].message.content;

          this.aiMessages.push({ role: "assistant", content: botReply });

          return botReply;
        } catch (error) {
          console.error('AI Error:', error);
          return "عذراً، حدث خطأ في الاتصال بالذكاء الاصطناعي. يرجى المحاولة مرة أخرى.";
        }
      }
      
      toggleAIChat() {
        const chat = document.getElementById('ai-chat-container');
        chat.style.display = chat.style.display === 'flex' ? 'none' : 'flex';
      }
      
      closeAIChat() {
        document.getElementById('ai-chat-container').style.display = 'none';
      }
      
      newAIChat() {
        this.initAI();
        document.getElementById('ai-chat-messages').innerHTML = `
          <div class="ai-chat-message ai">
            <div style="font-weight: 700;">مساعد تحداك:</div>
            <div>مرحباً! أنا مساعدك في لعبة تحداك. أنا هنا لأجيب على أسئلتك وأساعدك في استكشاف اللعبة. كيف يمكنني مساعدتك اليوم؟</div>
          </div>
        `;
      }
      
      async sendAIMessage() {
        const input = document.getElementById('ai-chat-input');
        const text = input.value.trim();
        
        if (!text) return;
        
        const messagesContainer = document.getElementById('ai-chat-messages');
        
        // إضافة رسالة المستخدم
        const userMessageElement = document.createElement('div');
        userMessageElement.className = 'ai-chat-message user';
        userMessageElement.innerHTML = `
          <div style="font-weight: 700;">أنت:</div>
          <div>${text}</div>
        `;
        messagesContainer.appendChild(userMessageElement);
        
        input.value = '';
        input.disabled = true;
        
        // إرسال للذكاء الاصطناعي
        const aiResponse = await this.sendToAI(text);
        
        // إضافة رد الذكاء الاصطناعي
        const aiMessageElement = document.createElement('div');
        aiMessageElement.className = 'ai-chat-message ai';
        aiMessageElement.innerHTML = `
          <div style="font-weight: 700;">مساعد تحداك:</div>
          <div>${aiResponse}</div>
        `;
        messagesContainer.appendChild(aiMessageElement);
        
        input.disabled = false;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
      
      // نظام الهدايا اليومية
      checkDailyGift() {
        const now = Date.now();
        const lastGift = this.currentUser.lastDailyGift || 0;
        const twelveHours = 12 * 60 * 60 * 1000; // 12 ساعة بالميلي ثانية
        
        if (now - lastGift >= twelveHours) {
          document.getElementById('daily-gift-overlay').style.display = 'flex';
        }
      }
      
      async claimDailyGift() {
        document.getElementById('daily-gift-overlay').style.display = 'none';
        
        this.currentUser.points += 15;
        this.currentUser.coins += 5;
        this.currentUser.lastDailyGift = Date.now();
        
        await this.db.ref('users/' + this.currentUser.name).update({
          points: this.currentUser.points,
          coins: this.currentUser.coins,
          lastDailyGift: this.currentUser.lastDailyGift
        });
        
        this.updateUI();
        this.showNotification('تم استلام هديتك اليومية! +15 نقطة و +5 عملات', 'success');
      }
      
      // نظام المهام
      loadDailyQuests() {
        const container = document.getElementById('daily-quests');
        container.innerHTML = '';
        
        this.dailyQuests.forEach(quest => {
          const questProgress = this.currentUser.quests?.[quest.id] || 0;
          const progressPercent = Math.min(100, (questProgress / quest.target) * 100);
          const isCompleted = questProgress >= quest.target;
          
          const questElement = document.createElement('div');
          questElement.className = 'quest-card';
          questElement.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <div style="font-weight: 700;">${quest.name}</div>
              <div style="color: var(--accent); font-size: 14px;">${questProgress}/${quest.target}</div>
            </div>
            <div class="quest-progress">
              <div class="quest-progress-bar" style="width: ${progressPercent}%"></div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
              <div style="font-size: 12px; color: var(--text-muted);">
                ${isCompleted ? 'مكتمل' : 'غير مكتمل'}
              </div>
              <div style="font-size: 12px; color: var(--accent);">
                +${quest.reward.points} نقطة • +${quest.reward.coins} عملة
              </div>
            </div>
            ${isCompleted ? `
              <button class="btn small" style="margin-top: 10px; width: 100%;" onclick="app.claimQuestReward('${quest.id}')">
                استلام الجائزة
              </button>
            ` : ''}
          `;
          container.appendChild(questElement);
        });
      }
      
      async updateQuestProgress(questId, progress = 1) {
        if (this.isGuest) return;
        
        const currentProgress = this.currentUser.quests?.[questId] || 0;
        const newProgress = currentProgress + progress;
        
        await this.db.ref(`users/${this.currentUser.name}/quests/${questId}`).set(newProgress);
        
        this.currentUser.quests = this.currentUser.quests || {};
        this.currentUser.quests[questId] = newProgress;
        
        this.loadDailyQuests();
      }
      
      async claimQuestReward(questId) {
        const quest = this.dailyQuests.find(q => q.id === questId);
        if (!quest) return;
        
        const questProgress = this.currentUser.quests?.[questId] || 0;
        if (questProgress < quest.target) {
          this.showNotification('لم تكتمل المهمة بعد', 'warning');
          return;
        }
        
        this.currentUser.points += quest.reward.points;
        this.currentUser.coins += quest.reward.coins;
        
        // إعادة تعيين تقدم المهمة
        await this.db.ref(`users/${this.currentUser.name}/quests/${questId}`).set(0);
        this.currentUser.quests[questId] = 0;
        
        await this.db.ref('users/' + this.currentUser.name).update({
          points: this.currentUser.points,
          coins: this.currentUser.coins
        });
        
        this.updateUI();
        this.loadDailyQuests();
        this.showNotification(`مبروك! أكملت المهمة وربحت ${quest.reward.points} نقطة و ${quest.reward.coins} عملة`, 'success');
      }
      
      // الألعاب
      startQuickGame(type) {
        if (this.isGuest) {
          this.showNotification('الزائر لا يمكنه المشاركة في الألعاب', 'warning');
          return;
        }
        
        this.showGameModal('اللعبة السريعة', 'events');
        
        switch(type) {
          case 'memory':
            this.startMemoryGame();
            break;
          case 'reaction':
            this.startReactionGame();
            break;
          case 'math':
            this.startMathGame();
            break;
          case 'puzzle':
            this.startPuzzleGame();
            break;
        }
      }
      
      startMemoryGame() {
        const symbols = ['🚀', '🌟', '🎯', '🎨', '🎭', '🎪', '🎮', '🎲'];
        const cards = [...symbols, ...symbols].sort(() => Math.random() - 0.5);
        
        this.currentGame = {
          type: 'memory',
          cards: cards,
          flipped: [],
          matched: [],
          moves: 0,
          startTime: Date.now()
        };
        
        this.renderMemoryGame();
      }
      
      renderMemoryGame() {
        const content = document.getElementById('game-content');
        content.innerHTML = `
          <div style="text-align: center;">
            <h3>لعبة الذاكرة</h3>
            <p>اطابق بين الازواج بأقل عدد من الحركات</p>
            <div class="memory-grid">
              ${this.currentGame.cards.map((card, index) => `
                <div class="memory-card ${this.currentGame.flipped.includes(index) || this.currentGame.matched.includes(index) ? 'flipped' : ''} ${this.currentGame.matched.includes(index) ? 'matched' : ''}" 
                     onclick="app.flipMemoryCard(${index})">
                  ${this.currentGame.flipped.includes(index) || this.currentGame.matched.includes(index) ? card : '?'}
                </div>
              `).join('')}
            </div>
            <div style="margin-top: 15px;">
              <div style="color: var(--text-muted);">الحركات: <span id="memory-moves">${this.currentGame.moves}</span></div>
            </div>
          </div>
        `;
      }
      
      flipMemoryCard(index) {
        if (this.currentGame.flipped.length >= 2 || 
            this.currentGame.flipped.includes(index) || 
            this.currentGame.matched.includes(index)) {
          return;
        }
        
        this.currentGame.flipped.push(index);
        this.currentGame.moves++;
        
        this.renderMemoryGame();
        
        if (this.currentGame.flipped.length === 2) {
          const [first, second] = this.currentGame.flipped;
          
          if (this.currentGame.cards[first] === this.currentGame.cards[second]) {
            this.currentGame.matched.push(first, second);
            this.currentGame.flipped = [];
            
            if (this.currentGame.matched.length === this.currentGame.cards.length) {
              setTimeout(() => {
                this.finishMemoryGame();
              }, 500);
            }
          } else {
            setTimeout(() => {
              this.currentGame.flipped = [];
              this.renderMemoryGame();
            }, 1000);
          }
        }
      }
      
      finishMemoryGame() {
        const timeTaken = Math.floor((Date.now() - this.currentGame.startTime) / 1000);
        const points = Math.max(5, 15 - this.currentGame.moves);
        
        document.getElementById('game-content').innerHTML = `
          <div style="text-align: center;">
            <h3 style="color: var(--success);">مبروك! أكملت اللعبة</h3>
            <div style="font-size: 48px; margin: 20px 0;">🎉</div>
            <div style="color: var(--text-light); margin-bottom: 20px;">
              <div>الوقت: ${timeTaken} ثانية</div>
              <div>الحركات: ${this.currentGame.moves}</div>
              <div>النقاط: <span style="color: var(--accent); font-weight: 700;">${points}</span></div>
            </div>
            <button class="btn" onclick="app.addGameReward(${points}, ${points}, 'memory-game')">استلام الجائزة</button>
          </div>
        `;
        
        this.updateQuestProgress('play-3-games');
      }
      
      startReactionGame() {
        document.getElementById('game-content').innerHTML = `
          <div style="text-align: center;">
            <h3>اختبار سرعة رد الفعل</h3>
            <p>اضغط على المربع عندما يتحول إلى اللون الأخضر</p>
            <div class="reaction-box" id="reaction-box" onclick="app.reactionTest()">
              اضغط عند تغير اللون!
            </div>
            <div id="reaction-result" style="color: var(--text-light);"></div>
          </div>
        `;
        
        const waitTime = Math.floor(Math.random() * 3000) + 1000;
        
        setTimeout(() => {
          const box = document.getElementById('reaction-box');
          const colors = ['#00c48c', '#ff3366', '#ffd166', '#9b5de5', '#2575fc'];
          const randomColor = colors[Math.floor(Math.random() * colors.length)];
          
          box.style.background = randomColor;
          box.classList.add('active');
          box.textContent = 'اضغط الآن!';
          box.style.color = 'white';
          
          this.reactionStartTime = Date.now();
          box.onclick = () => {
            const reactionTime = Date.now() - this.reactionStartTime;
            box.onclick = null;
            
            let points = 0;
            if (reactionTime < 200) points = 10;
            else if (reactionTime < 350) points = 8;
            else if (reactionTime < 500) points = 5;
            else points = 3;
            
            document.getElementById('reaction-result').innerHTML = `
              زمن رد فعلك: <span style="color: var(--accent); font-weight: 700;">${reactionTime} مللي ثانية</span><br>
              ربحت <span style="color: var(--accent); font-weight: 700;">${points} نقاط</span> و <span style="color: var(--accent); font-weight: 700;">${points} عملات</span>
            `;
            
            box.style.pointerEvents = 'none';
            box.textContent = 'انتهى التحدي!';
            box.classList.remove('active');
            
            setTimeout(() => {
              this.addGameReward(points, points, 'reaction-test');
            }, 2000);
          };
        }, waitTime);
      }
      
      reactionTest() {
        this.showNotification('انتظر حتى يتغير اللون!', 'warning');
      }
      
      startMathGame() {
        const num1 = Math.floor(Math.random() * 20) + 1;
        const num2 = Math.floor(Math.random() * 20) + 1;
        const operators = ['+', '-', '*'];
        const operator = operators[Math.floor(Math.random() * operators.length)];
        
        let problem = '';
        let answer = 0;
        
        switch(operator) {
          case '+':
            problem = `${num1} + ${num2}`;
            answer = num1 + num2;
            break;
          case '-':
            problem = `${num1} - ${num2}`;
            answer = num1 - num2;
            break;
          case '*':
            problem = `${num1} × ${num2}`;
            answer = num1 * num2;
            break;
        }
        
        const options = [answer];
        while (options.length < 4) {
          const randomAnswer = answer + Math.floor(Math.random() * 10) - 5;
          if (randomAnswer !== answer && !options.includes(randomAnswer)) {
            options.push(randomAnswer);
          }
        }
        
        options.sort(() => Math.random() - 0.5);
        
        document.getElementById('game-content').innerHTML = `
          <div style="text-align: center;">
            <h3>تحدي الرياضيات</h3>
            <div class="quiz-question">${problem}</div>
            <div class="quiz-options">
              ${options.map((option, index) => `
                <div class="quiz-option" onclick="app.checkMathAnswer(${option}, ${answer})">${option}</div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      checkMathAnswer(selected, correct) {
        const options = document.querySelectorAll('.quiz-option');
        options.forEach(option => {
          option.style.pointerEvents = 'none';
          if (parseInt(option.textContent) === correct) {
            option.classList.add('correct');
          } else if (parseInt(option.textContent) === selected) {
            option.classList.add('incorrect');
          }
        });
        
        if (selected === correct) {
          setTimeout(() => {
            this.addGameReward(10, 10, 'math-game');
          }, 1500);
        } else {
          setTimeout(() => {
            document.getElementById('game-content').innerHTML = `
              <div style="text-align: center;">
                <h3 style="color: var(--danger);">إجابة خاطئة</h3>
                <div style="color: var(--text-light); margin: 20px 0;">
                  الإجابة الصحيحة هي: <span style="color: var(--accent); font-weight: 700;">${correct}</span>
                </div>
                <button class="btn" onclick="app.closeGameModal()">إغلاق</button>
              </div>
            `;
          }, 1500);
        }
      }
      
      startPuzzleGame() {
        const puzzle = this.quizBank.riddles[Math.floor(Math.random() * this.quizBank.riddles.length)];
        
        document.getElementById('game-content').innerHTML = `
          <div style="text-align: center;">
            <h3>تحدي الألغاز</h3>
            <div class="quiz-question">${puzzle.q}</div>
            <input type="text" id="puzzle-answer" placeholder="اكتب إجابتك هنا..." style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: rgba(10, 10, 10, 0.7); color: var(--text); margin-top: 15px;">
            <button class="btn" onclick="app.checkPuzzleAnswer('${puzzle.answer}')" style="margin-top: 15px; width: 100%;">تحقق من الإجابة</button>
          </div>
        `;
      }
      
      checkPuzzleAnswer(correctAnswer) {
        const answer = document.getElementById('puzzle-answer').value.trim().toLowerCase();
        
        if (!answer) {
          this.showNotification('يرجى إدخال إجابة', 'error');
          return;
        }
        
        if (answer === correctAnswer.toLowerCase()) {
          document.getElementById('game-content').innerHTML = `
            <div style="text-align: center;">
              <h3 style="color: var(--success);">إجابة صحيحة!</h3>
              <div style="color: var(--text-light); margin: 20px 0;">
                لقد كسبت <span style="color: var(--accent); font-weight: 700;">8 نقاط</span> و <span style="color: var(--accent); font-weight: 700;">8 عملات</span>
              </div>
              <button class="btn" onclick="app.addGameReward(8, 8, 'puzzle-game')">استلام الجائزة</button>
            </div>
          `;
        } else {
          document.getElementById('game-content').innerHTML = `
            <div style="text-align: center;">
              <h3 style="color: var(--danger);">إجابة خاطئة</h3>
              <div style="color: var(--text-light); margin: 20px 0;">
                الإجابة الصحيحة هي: <span style="color: var(--accent); font-weight: 700;">${correctAnswer}</span>
              </div>
              <button class="btn" onclick="app.closeGameModal()">إغلاق</button>
            </div>
          `;
        }
      }
      
      startQuiz(level) {
        const bank = this.quizBank[level] || this.quizBank.easy;
        if (bank.length === 0) {
          this.showNotification('لا توجد أسئلة متاحة حالياً', 'error');
          return;
        }
        
        const questions = [...bank].sort(() => 0.5 - Math.random()).slice(0, 5);
        
        this.currentGame = {
          type: 'quiz',
          level,
          questions,
          currentQuestionIndex: 0,
          score: 0,
          startTime: Date.now()
        };
        
        this.showQuizQuestion();
      }
      
      showQuizQuestion() {
        if (!this.currentGame) return;
        
        const question = this.currentGame.questions[this.currentGame.currentQuestionIndex];
        const content = document.getElementById('game-content');
        
        content.innerHTML = `
          <div class="quiz-container">
            <div class="progress-bar">
              <div class="progress" style="width: ${((this.currentGame.currentQuestionIndex + 1) / this.currentGame.questions.length) * 100}%"></div>
            </div>
            <div class="quiz-question">${question.q}</div>
            <div class="quiz-options">
              ${question.choices.map((choice, index) => `
                <div class="quiz-option" onclick="app.submitQuizAnswer(${index})">${choice}</div>
              `).join('')}
            </div>
            <div style="margin-top: 15px; color: var(--text-muted); font-size: 14px;">
              السؤال ${this.currentGame.currentQuestionIndex + 1} من ${this.currentGame.questions.length}
            </div>
          </div>
        `;
      }
      
      submitQuizAnswer(answerIndex) {
        if (!this.currentGame) return;
        
        const question = this.currentGame.questions[this.currentGame.currentQuestionIndex];
        const isCorrect = answerIndex === question.a;
        
        const options = document.querySelectorAll('.quiz-option');
        options.forEach((option, index) => {
          if (index === question.a) {
            option.classList.add('correct');
          } else if (index === answerIndex && !isCorrect) {
            option.classList.add('incorrect');
          }
          option.style.pointerEvents = 'none';
        });
        
        if (isCorrect) {
          this.currentGame.score++;
        }
        
        setTimeout(() => {
          this.currentGame.currentQuestionIndex++;
          
          if (this.currentGame.currentQuestionIndex < this.currentGame.questions.length) {
            this.showQuizQuestion();
          } else {
            this.finishQuiz();
          }
        }, 1500);
      }
      
      finishQuiz() {
        if (!this.currentGame) return;
        
        const points = this.currentGame.level === 'easy' ? 5 : this.currentGame.level === 'medium' ? 10 : 20;
        const totalPoints = this.currentGame.score * points;
        
        document.getElementById('game-content').innerHTML = `
          <div class="quiz-container">
            <h3>انتهى الاختبار!</h3>
            <div style="font-size: 48px; color: var(--primary); margin: 20px 0;">${this.currentGame.score}/${this.currentGame.questions.length}</div>
            <div style="color: var(--text-light); margin-bottom: 20px;">
              لقد كسبت <span style="color: var(--accent); font-weight: 700;">${totalPoints} نقطة</span> و <span style="color: var(--accent); font-weight: 700;">${totalPoints} عملة</span>
            </div>
            <button class="btn" onclick="app.addGameReward(${totalPoints}, ${totalPoints}, 'quiz-${this.currentGame.level}')">استلام الجائزة</button>
          </div>
        `;
        
        this.currentGame = null;
        this.updateQuestProgress('complete-quiz');
        this.updateQuestProgress('play-3-games');
      }
      
      startRiddle() {
        const riddle = this.quizBank.riddles[Math.floor(Math.random() * this.quizBank.riddles.length)];
        
        document.getElementById('game-content').innerHTML = `
          <div style="text-align: center;">
            <h3>تحدي الألغاز</h3>
            <div class="quiz-question">${riddle.q}</div>
            <input type="text" id="riddle-answer" placeholder="اكتب إجابتك هنا..." style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: rgba(10, 10, 10, 0.7); color: var(--text); margin-top: 15px;">
            <button class="btn" onclick="app.checkRiddleAnswer('${riddle.answer}')" style="margin-top: 15px; width: 100%;">تحقق من الإجابة</button>
          </div>
        `;
      }
      
      checkRiddleAnswer(correctAnswer) {
        const answer = document.getElementById('riddle-answer').value.trim().toLowerCase();
        
        if (!answer) {
          this.showNotification('يرجى إدخال إجابة', 'error');
          return;
        }
        
        if (answer === correctAnswer.toLowerCase()) {
          document.getElementById('game-content').innerHTML = `
            <div style="text-align: center;">
              <h3 style="color: var(--success);">إجابة صحيحة!</h3>
              <div style="color: var(--text-light); margin: 20px 0;">
                لقد كسبت <span style="color: var(--accent); font-weight: 700;">10 نقاط</span> و <span style="color: var(--accent); font-weight: 700;">10 عملات</span>
              </div>
              <button class="btn" onclick="app.addGameReward(10, 10, 'riddle')">استلام الجائزة</button>
            </div>
          `;
        } else {
          document.getElementById('game-content').innerHTML = `
            <div style="text-align: center;">
              <h3 style="color: var(--danger);">إجابة خاطئة</h3>
              <div style="color: var(--text-light); margin: 20px 0;">
                الإجابة الصحيحة هي: <span style="color: var(--accent); font-weight: 700;">${correctAnswer}</span>
              </div>
              <button class="btn" onclick="app.closeGameModal()">إغلاق</button>
            </div>
          `;
        }
      }
      
      startLogicChallenge() {
        const puzzle = this.quizBank.logic[Math.floor(Math.random() * this.quizBank.logic.length)];
        
        document.getElementById('game-content').innerHTML = `
          <div style="text-align: center;">
            <h3>تحدي المنطق</h3>
            <div class="quiz-question">${puzzle.q}</div>
            <div class="quiz-options">
              ${puzzle.choices.map((choice, index) => `
                <div class="quiz-option" onclick="app.checkLogicAnswer(${index}, ${puzzle.a})">${choice}</div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      checkLogicAnswer(selected, correct) {
        const options = document.querySelectorAll('.quiz-option');
        options.forEach((option, index) => {
          option.style.pointerEvents = 'none';
          if (index === correct) {
            option.classList.add('correct');
          } else if (index === selected) {
            option.classList.add('incorrect');
          }
        });
        
        if (selected === correct) {
          setTimeout(() => {
            this.addGameReward(12, 12, 'logic-challenge');
          }, 1500);
        }
      }
      
      startWordChallenge() {
        const puzzle = this.quizBank.words[Math.floor(Math.random() * this.quizBank.words.length)];
        
        document.getElementById('game-content').innerHTML = `
          <div style="text-align: center;">
            <h3>تحدي الكلمات</h3>
            <div class="quiz-question">${puzzle.q}</div>
            <div class="quiz-options">
              ${puzzle.choices.map((choice, index) => `
                <div class="quiz-option" onclick="app.checkWordAnswer(${index}, ${puzzle.a})">${choice}</div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      checkWordAnswer(selected, correct) {
        const options = document.querySelectorAll('.quiz-option');
        options.forEach((option, index) => {
          option.style.pointerEvents = 'none';
          if (index === correct) {
            option.classList.add('correct');
          } else if (index === selected) {
            option.classList.add('incorrect');
          }
        });
        
        if (selected === correct) {
          setTimeout(() => {
            this.addGameReward(8, 8, 'word-challenge');
          }, 1500);
        }
      }
      
      startColorChallenge() {
        const puzzle = this.quizBank.colors[Math.floor(Math.random() * this.quizBank.colors.length)];
        
        document.getElementById('game-content').innerHTML = `
          <div style="text-align: center;">
            <h3>تحدي الألوان</h3>
            <div class="quiz-question">${puzzle.q}</div>
            <div class="quiz-options">
              ${puzzle.choices.map((choice, index) => `
                <div class="quiz-option" onclick="app.checkColorAnswer(${index}, ${puzzle.a})">${choice}</div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      checkColorAnswer(selected, correct) {
        const options = document.querySelectorAll('.quiz-option');
        options.forEach((option, index) => {
          option.style.pointerEvents = 'none';
          if (index === correct) {
            option.classList.add('correct');
          } else if (index === selected) {
            option.classList.add('incorrect');
          }
        });
        
        if (selected === correct) {
          setTimeout(() => {
            this.addGameReward(10, 10, 'color-challenge');
          }, 1500);
        }
      }
      
      startBattleMemory() {
        this.startMemoryGame();
      }
      
      startBattleReaction() {
        this.startReactionGame();
      }
      
      startBattleMath() {
        this.startMathGame();
      }
      
      async addGameReward(points, coins, reason) {
        if (this.isGuest) return;
        
        this.currentUser.points += points;
        this.currentUser.coins += coins;
        
        await this.db.ref('users/' + this.currentUser.name).update({
          points: this.currentUser.points,
          coins: this.currentUser.coins
        });
        
        this.updateUI();
        this.showNotification(`مبروك! ربحت ${points} نقطة و ${coins} عملة`, 'success');
        
        setTimeout(() => {
          this.closeGameModal();
        }, 2000);
        
        this.updateQuestProgress('play-3-games');
        this.updateQuestProgress('win-2-games');
      }
      
      async addPoints(username, points, reason) {
        const userRef = this.db.ref('users/' + username);
        const snapshot = await userRef.once('value');
        const userData = snapshot.val() || {};
        
        userData.points = (userData.points || 0) + points;
        userData.level = 1 + Math.floor((userData.points || 0) / 100);
        
        await userRef.update({
          points: userData.points,
          level: userData.level
        });
        
        await this.db.ref('pointsHistory/' + username).push({
          pts: points,
          ts: Date.now(),
          reason: reason
        });
      }
      
      async addCoins(username, coins, reason) {
        const userRef = this.db.ref('users/' + username);
        const snapshot = await userRef.once('value');
        const userData = snapshot.val() || {};
        
        userData.coins = (userData.coins || 0) + coins;
        
        await userRef.update({
          coins: userData.coins
        });
      }
      
      async buyItem(itemId) {
        if (this.isGuest) {
          this.showNotification('يجب تسجيل الدخول أولاً', 'error');
          return;
        }
        
        const itemPrices = {
          'diamond-frame': 50,
          'fire-badge': 30,
          'star-bg': 75,
          'double-challenge': 40,
          'pride-crown': 100,
          'protection-shield': 60
        };
        
        const price = itemPrices[itemId];
        
        if (!price) {
          this.showNotification('العنصر غير موجود', 'error');
          return;
        }
        
        if (this.currentUser.coins < price) {
          this.showNotification('رصيدك غير كافي لشراء هذا العنصر', 'error');
          return;
        }
        
        if (this.currentUser.items && this.currentUser.items.includes(itemId)) {
          this.showNotification('أنت تمتلك هذا العنصر مسبقاً', 'warning');
          return;
        }
        
        // تأكيد الشراء
        if (!confirm(`هل تريد شراء ${this.getItemName(itemId)} بسعر ${price} عملة؟`)) {
          return;
        }
        
        const userRef = this.db.ref('users/' + this.currentUser.name);
        const updates = {
          coins: this.currentUser.coins - price
        };
        
        const userItems = this.currentUser.items || [];
        userItems.push(itemId);
        updates.items = userItems;
        
        await userRef.update(updates);
        
        this.currentUser.coins = this.currentUser.coins - price;
        this.currentUser.items = userItems;
        
        this.updateUI();
        this.showNotification(`تم شراء ${this.getItemName(itemId)} بنجاح!`, 'success');
      }
      
      getItemName(itemId) {
        const itemNames = {
          'diamond-frame': 'إطار الماس',
          'fire-badge': 'شارة النار',
          'star-bg': 'خلفية النجوم',
          'double-challenge': 'تحدي مزدوج',
          'pride-crown': 'تاج الفخر',
          'protection-shield': 'درع الحماية'
        };
        
        return itemNames[itemId] || itemId;
      }
      
      renderBadges() {
        const badgesContainer = document.getElementById('me-badges');
        const profileBadgesContainer = document.getElementById('profile-badges');
        
        badgesContainer.innerHTML = '';
        profileBadgesContainer.innerHTML = '';
        
        if (this.currentUser.badges && this.currentUser.badges.length > 0) {
          this.currentUser.badges.forEach(badge => {
            const badgeElement = document.createElement('div');
            badgeElement.className = 'badge';
            badgeElement.textContent = badge;
            
            badgesContainer.appendChild(badgeElement.cloneNode(true));
            profileBadgesContainer.appendChild(badgeElement);
          });
        }
      }
      
      renderOwnedItems() {
        const itemsContainer = document.getElementById('profile-items');
        itemsContainer.innerHTML = '';
        
        if (this.currentUser.items && this.currentUser.items.length > 0) {
          this.currentUser.items.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'badge';
            itemElement.style.background = 'linear-gradient(135deg, var(--secondary), #00a07a)';
            itemElement.textContent = this.getItemName(item);
            
            itemsContainer.appendChild(itemElement);
          });
        } else {
          itemsContainer.innerHTML = '<div style="color: var(--text-muted); font-size: 14px;">لا توجد عناصر مملوكة</div>';
        }
      }
      
      async renderLeaderboard(period = 'all') {
        const list = document.getElementById('leaders-list');
        list.innerHTML = '<div class="small" style="color: var(--text-muted); text-align: center; padding: 20px;">جارٍ التحميل...</div>';
        
        try {
          let leaders = [];
          
          if (period === 'all') {
            const snapshot = await this.db.ref('users').orderByChild('points').limitToLast(100).once('value');
            const users = snapshot.val() || {};
            
            leaders = Object.values(users)
              .filter(user => user.points >= 10)
              .sort((a, b) => (b.points || 0) - (a.points || 0))
              .slice(0, 10);
          } else {
            const snapshot = await this.db.ref('users').orderByChild('points').limitToLast(100).once('value');
            const users = snapshot.val() || {};
            
            leaders = Object.values(users)
              .filter(user => user.points >= 10)
              .sort((a, b) => (b.points || 0) - (a.points || 0))
              .slice(0, 10);
          }
          
          if (leaders.length === 0) {
            list.innerHTML = '<div class="small" style="color: var(--text-muted); text-align: center; padding: 20px;">لا يوجد لاعبين بعد</div>';
            return;
          }
          
          list.innerHTML = leaders.map((user, index) => {
            let crown = '';
            if (index === 0) crown = '<i class="fas fa-crown" style="color: var(--accent)"></i>';
            else if (index === 1) crown = '<i class="fas fa-medal" style="color: silver"></i>';
            else if (index === 2) crown = '<i class="fas fa-medal" style="color: #cd7f32"></i>';
            
            const verifiedBadge = user.verified ? '<i class="fas fa-check-circle verified-badge"></i>' : '';
            
            return `
              <div class="leader-item">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <span class="crown">${crown}</span>
                  <img src="${user.photo}" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">
                  <div>
                    <strong>${user.name} ${verifiedBadge}</strong>
                    <div style="color: var(--text-muted); font-size: 12px;">ID: ${user.id} | المستوى ${user.level || 1}</div>
                  </div>
                </div>
                <div style="text-align: left;">
                  <div style="font-weight: 700; color: var(--primary);">${user.points || 0}</div>
                  <div style="font-size: 12px; color: var(--text-muted);">نقطة</div>
                </div>
              </div>
            `;
          }).join('');
        } catch (error) {
          console.error('Error loading leaderboard:', error);
          list.innerHTML = '<div class="small" style="color: var(--danger); text-align: center; padding: 20px;">حدث خطأ في تحميل المتصدرين</div>';
        }
      }
      
      editProfile() {
        const overlay = document.getElementById('game-overlay');
        overlay.style.display = 'block';
        document.getElementById('game-title').textContent = 'تعديل الملف الشخصي';
        
        document.getElementById('game-content').innerHTML = `
          <div style="padding: 20px;">
            <h3>تعديل الملف الشخصي</h3>
            <input type="text" id="edit-name" value="${this.currentUser.name}" placeholder="الاسم" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: rgba(10, 10, 10, 0.7); color: var(--text); margin-bottom: 15px;">
            <textarea id="edit-bio" placeholder="نبذة عنك" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: rgba(10, 10, 10, 0.7); color: var(--text); margin-bottom: 15px; height: 100px;">${this.currentUser.bio || ''}</textarea>
            <input type="file" id="edit-photo" accept="image/*" style="width: 100%; margin-bottom: 15px;">
            <div style="display:flex;gap:10px;margin-top:14px">
              <button class="btn" onclick="app.saveProfileChanges()">حفظ</button>
              <button class="btn ghost" onclick="app.closeGameModal()">إلغاء</button>
            </div>
          </div>
        `;
      }
      
      async saveProfileChanges() {
        const newName = document.getElementById('edit-name').value.trim();
        const newBio = document.getElementById('edit-bio').value;
        const file = document.getElementById('edit-photo').files[0];
        
        if (!newName) {
          this.showNotification('يرجى إدخال اسم صالح', 'error');
          return;
        }
        
        let photoUrl = this.currentUser.photo;
        
        if (file) {
          try {
            const ref = this.storage.ref('profiles/' + Date.now() + '_' + file.name);
            const snap = await ref.put(file);
            photoUrl = await snap.ref.getDownloadURL();
          } catch (error) {
            console.error('Error uploading image:', error);
            this.showNotification('حدث خطأ في رفع الصورة', 'error');
            return;
          }
        }
        
        const userRef = this.db.ref('users/' + this.currentUser.name);
        
        if (newName !== this.currentUser.name) {
          const newUserRef = this.db.ref('users/' + newName);
          await newUserRef.set({
            ...this.currentUser,
            name: newName,
            bio: newBio,
            photo: photoUrl
          });
          
          await userRef.remove();
          
          localStorage.setItem('tahdak_user', JSON.stringify({ name: newName, photo: photoUrl }));
          
          this.currentUser.name = newName;
          this.currentUser.bio = newBio;
          this.currentUser.photo = photoUrl;
        } else {
          await userRef.update({
            bio: newBio,
            photo: photoUrl
          });
          
          this.currentUser.bio = newBio;
          this.currentUser.photo = photoUrl;
        }
        
        this.updateUI();
        this.closeGameModal();
        this.showNotification('تم تحديث الملف الشخصي بنجاح', 'success');
      }
      
      editBio() {
        const overlay = document.getElementById('game-overlay');
        overlay.style.display = 'block';
        document.getElementById('game-title').textContent = 'تعديل النبذة';
        
        document.getElementById('game-content').innerHTML = `
          <div style="padding: 20px;">
            <h3>تعديل النبذة</h3>
            <textarea id="edit-bio-only" placeholder="اكتب نبذة عنك" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: rgba(10, 10, 10, 0.7); color: var(--text); height: 120px;">${this.currentUser.bio || ''}</textarea>
            <div style="display:flex;gap:10px;margin-top:14px">
              <button class="btn" onclick="app.saveBio()">حفظ</button>
              <button class="btn ghost" onclick="app.closeGameModal()">إلغاء</button>
            </div>
          </div>
        `;
      }
      
      async saveBio() {
        const newBio = document.getElementById('edit-bio-only').value;
        
        const userRef = this.db.ref('users/' + this.currentUser.name);
        await userRef.update({
          bio: newBio
        });
        
        this.currentUser.bio = newBio;
        this.updateUI();
        this.closeGameModal();
        this.showNotification('تم تحديث النبذة بنجاح', 'success');
      }
      
      copyUserId() {
        if (!this.currentUser || !this.currentUser.id) {
          this.showNotification('لا يوجد معرف مستخدم', 'error');
          return;
        }
        
        navigator.clipboard.writeText(this.currentUser.id.toString())
          .then(() => {
            this.showNotification('تم نسخ المعرف بنجاح', 'success');
          })
          .catch(err => {
            console.error('Error copying text: ', err);
            this.showNotification('فشل في نسخ المعرف', 'error');
          });
      }
      
      showNotification(message, type = 'info') {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        let icon = 'info-circle';
        if (type === 'success') icon = 'check-circle';
        if (type === 'error') icon = 'exclamation-circle';
        if (type === 'warning') icon = 'exclamation-triangle';
        
        notification.innerHTML = `
          <i class="fas fa-${icon}"></i>
          <div>${message}</div>
        `;
        
        container.appendChild(notification);
        
        setTimeout(() => {
          notification.style.animation = 'slideInRight 0.3s ease-out reverse';
          setTimeout(() => {
            container.removeChild(notification);
          }, 300);
        }, 5000);
      }
      
      showLogoutConfirm() {
        document.getElementById('logout-confirm').style.display = 'flex';
      }
      
      hideLogoutConfirm() {
        document.getElementById('logout-confirm').style.display = 'none';
      }
      
      logout() {
        this.hideLogoutConfirm();
        
        if (this.currentUser && !this.isGuest) {
          this.db.ref('onlineUsers/' + this.currentUser.name).set({
            online: false,
            lastActive: Date.now()
          });
        }
        
        this.currentUser = null;
        this.isGuest = false;
        
        localStorage.removeItem('tahdak_user');
        
        document.getElementById('login-overlay').style.display = 'flex';
        this.showNotification('تم تسجيل الخروج بنجاح', 'success');
      }
      
      toggleSound() {
        this.soundEnabled = !this.soundEnabled;
        const btn = document.getElementById('btn-sound-toggle');
        
        if (this.soundEnabled) {
          btn.innerHTML = '<i class="fas fa-volume-up"></i> صوت';
          this.showNotification('تم تفعيل الصوت', 'success');
        } else {
          btn.innerHTML = '<i class="fas fa-volume-mute"></i> صوت';
          this.showNotification('تم إيقاف الصوت', 'info');
        }
      }
      
      showLoading(message = 'جاري التحميل...') {
        document.getElementById('loading-screen').style.display = 'flex';
        document.querySelector('#loading-screen h3').textContent = message;
      }
      
      hideLoading() {
        document.getElementById('loading-screen').style.display = 'none';
      }
    }
    
    let app;
    window.addEventListener('load', () => {
      app = new TahdakApp();
      window.app = app;
    });
  </script>
</body>
</html>
