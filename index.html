<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تحداك — منصة منافسات ألعاب</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* --- Global Styles --- */
    :root {
      --primary: #ff3366;
      --primary-dark: #ff0055;
      --secondary: #00c48c;
      --accent: #ffd166;
      --bg-dark: #0a0a0a;
      --bg-card: #111111;
      --bg-card-light: #1a1a1a;
      --text: #ffffff;
      --text-light: #bbbbbb;
      --text-muted: #888888;
      --border: rgba(255,255,255,0.06);
      --success: #00c48c;
      --danger: #ff3366;
      --warning: #ffaf3f;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      background-color: var(--bg-dark);
      color: var(--text);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      direction: rtl;
      text-align: right;
      overflow-x: hidden;
      height: 100%;
    }
    
    body {
      padding-bottom: 80px;
    }
    
    /* --- Layout --- */
    header {
      padding: 16px;
      background: linear-gradient(90deg, var(--bg-card), var(--bg-dark));
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    header h1 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 1px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
    }
    
    main {
      padding: 18px;
      padding-bottom: 110px;
      min-height: calc(100vh - 120px);
      animation: fadeIn 0.3s ease-out;
    }
    
    nav.bottom {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-card);
      display: flex;
      justify-content: space-around;
      padding: 10px 6px;
      border-top: 1px solid var(--border);
      z-index: 20;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2);
    }
    
    nav.bottom button {
      background: transparent;
      color: var(--text-light);
      border: 0;
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: all 0.3s ease;
    }
    
    nav.bottom button i {
      font-size: 18px;
    }
    
    nav.bottom button.active {
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      color: var(--text);
      box-shadow: 0 6px 20px rgba(255, 59, 107, 0.2);
      transform: translateY(-4px);
    }
    
    section {
      display: none;
      animation: slideUp 0.3s ease-out;
    }
    
    section.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: none; }
    }
    
    /* --- Cards & Controls --- */
    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    
    .center {
      text-align: center;
    }
    
    input[type="text"], input[type="file"] {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--bg-dark);
      color: var(--text);
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(255, 51, 102, 0.2);
    }
    
    .row {
      display: flex;
      gap: 8px;
    }
    
    .btn {
      display: inline-block;
      padding: 12px 18px;
      border-radius: 12px;
      border: 0;
      cursor: pointer;
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      color: var(--text);
      font-weight: 600;
      transition: all 0.3s ease;
      text-align: center;
      box-shadow: 0 4px 12px rgba(255, 51, 102, 0.2);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 51, 102, 0.3);
    }
    
    .btn.ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-light);
      box-shadow: none;
    }
    
    .btn.ghost:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateY(-2px);
    }
    
    .btn.secondary {
      background: linear-gradient(90deg, var(--secondary), #00a07a);
      box-shadow: 0 4px 12px rgba(0, 196, 140, 0.2);
    }
    
    .btn.secondary:hover {
      box-shadow: 0 6px 16px rgba(0, 196, 140, 0.3);
    }
    
    .small {
      font-size: 13px;
      padding: 10px 14px;
      border-radius: 10px;
    }
    
    /* --- Profile --- */
    .profile-img {
      width: 88px;
      height: 88px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .profile-row {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .stats {
      display: flex;
      justify-content: space-between;
      margin-top: 16px;
    }
    
    .stat {
      text-align: center;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    /* --- Leaderboard --- */
    .leader-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-radius: 12px;
      background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.03));
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }
    
    .leader-item:hover {
      background: linear-gradient(90deg, rgba(255,255,255,0.04), rgba(255,255,255,0.05));
      transform: translateX(-5px);
    }
    
    .crown {
      color: var(--accent);
      margin-left: 8px;
    }
    
    /* --- Challenges --- */
    .challenge-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      background: var(--bg-card-light);
      transition: all 0.3s ease;
    }
    
    .challenge-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    
    .tag {
      background: rgba(255, 255, 255, 0.06);
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      color: var(--text-light);
    }
    
    /* --- Overlay & Modal --- */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
      animation: fadeIn 0.3s ease;
    }
    
    .modal {
      background: var(--bg-card);
      padding: 24px;
      border-radius: 16px;
      width: 92%;
      max-width: 500px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }
    
    .notify {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 90px;
      background: linear-gradient(90deg, var(--secondary), #00a07a);
      color: var(--text);
      padding: 12px 20px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      z-index: 70;
      display: none;
      animation: slideUp 0.3s ease;
    }
    
    /* --- Badges & Items --- */
    .badges {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    
    .badge {
      padding: 6px 10px;
      border-radius: 8px;
      background: linear-gradient(90deg, var(--accent), #ffaf3f);
      color: #111;
      font-weight: 700;
      font-size: 12px;
      box-shadow: 0 2px 8px rgba(255, 209, 102, 0.3);
    }
    
    /* --- XO Game --- */
    .xo-board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin: 20px auto;
      max-width: 300px;
    }
    
    .xo-cell {
      aspect-ratio: 1;
      background: var(--bg-card-light);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .xo-cell:hover {
      background: var(--bg-card);
      border-color: var(--primary);
    }
    
    .xo-cell.x {
      color: var(--primary);
    }
    
    .xo-cell.o {
      color: var(--secondary);
    }
    
    .xo-rooms {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }
    
    .xo-room {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-radius: 12px;
      background: var(--bg-card-light);
      transition: all 0.3s ease;
    }
    
    .xo-room:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    
    /* --- Store --- */
    .store-items {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 16px;
    }
    
    .store-item {
      background: var(--bg-card-light);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .store-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    
    .item-icon {
      font-size: 32px;
      margin-bottom: 10px;
      color: var(--accent);
    }
    
    .item-price {
      color: var(--accent);
      font-weight: 700;
      margin: 8px 0;
    }
    
    /* --- Quiz --- */
    .quiz-container {
      text-align: center;
    }
    
    .quiz-question {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
    }
    
    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .quiz-option {
      padding: 14px;
      border-radius: 10px;
      background: var(--bg-card-light);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .quiz-option:hover {
      background: var(--bg-card);
      transform: translateY(-2px);
    }
    
    .quiz-option.correct {
      background: var(--success);
      color: white;
    }
    
    .quiz-option.incorrect {
      background: var(--danger);
      color: white;
    }
    
    .progress-bar {
      height: 6px;
      background: var(--bg-card-light);
      border-radius: 3px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .progress {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      border-radius: 3px;
      transition: width 0.5s ease;
    }
    
    /* --- Responsive --- */
    @media (min-width: 900px) {
      main {
        max-width: 920px;
        margin: 0 auto;
      }
      nav.bottom {
        width: 920px;
        left: 50%;
        transform: translateX(-50%);
        border-radius: 16px 16px 0 0;
      }
      .store-items {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    /* --- Animations --- */
    .pulse {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .shake {
      animation: shake 0.5s;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    .bounce {
      animation: bounce 0.5s;
    }
    
    @keyframes bounce {
      0%, 20%, 53%, 80%, 100% {
        transform: translateY(0);
      }
      40%, 43% {
        transform: translateY(-10px);
      }
      70% {
        transform: translateY(-5px);
      }
    }
    
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body oncontextmenu="return false;" oncopy="return false;" oncut="return false;" onpaste="return false;">
  <header>
    <div>
      <h1><i class="fas fa-gamepad"></i> تحداك</h1>
      <div style="font-size:13px;color:var(--text-light);margin-top:4px" id="header-sub">مرحبا بك</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <div id="online-count" style="font-size:14px;color:var(--secondary)"><i class="fas fa-wifi"></i> أونلاين: 0</div>
      <button class="btn ghost small" id="btn-sound-toggle"><i class="fas fa-volume-up"></i> صوت</button>
    </div>
  </header>

  <main>
    <!-- Login Section -->
    <section id="sec-login" class="active">
      <div class="card center">
        <h2>تسجيل سريع</h2>
        <p class="small" style="color:var(--text-light)">سجّل باسمك وارفع صورة الملف الشخصي</p>
        <input id="inp-name" type="text" placeholder="اكتب اسمك...">
        <input id="inp-photo" type="file" accept="image/*">
        <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
          <button class="btn" id="btn-start">ابدأ الآن</button>
          <button class="btn ghost" id="btn-guest">دخول كزائر</button>
        </div>
      </div>
      
      <div class="card">
        <h3>لمحة</h3>
        <p style="color:var(--text-light)">موقع منافسات على شكل لعبة: تحديات فردية و 1 ضد 1، متصدرين، أوسمة، ونظام نقاط متقدم.</p>
      </div>
    </section>

    <!-- Home Section -->
    <section id="sec-home">
      <div class="card profile-row">
        <img id="me-photo" class="profile-img" src="" alt="صورة" />
        <div style="flex-grow: 1;">
          <div id="me-name" style="font-weight:700">ضيف</div>
          <div style="color:var(--text-muted)">مستوى: <span id="me-level">0</span> • نقاط: <span id="me-points">0</span></div>
          <div class="badges" id="me-badges"></div>
        </div>
        <div style="text-align: center; background: var(--bg-card-light); padding: 8px 12px; border-radius: 10px;">
          <div style="color: var(--accent); font-weight: 700; font-size: 18px;" id="me-coins">0</div>
          <div style="font-size: 12px; color: var(--text-muted);"><i class="fas fa-coins"></i> عملات</div>
        </div>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="stat-wins">0</div>
          <div class="stat-label">انتصارات</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-losses">0</div>
          <div class="stat-label">خسائر</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-label">إجمالي</div>
        </div>
      </div>

      <div class="card">
        <h3>الأقسام</h3>
        <div style="display:flex;flex-direction:column;gap:10px;margin-top:12px">
          <button class="btn" onclick="goto('sec-challenges')"><i class="fas fa-bullseye"></i> ابدأ تحدي</button>
          <button class="btn" onclick="goto('sec-battle')"><i class="fas fa-fist-raised"></i> تحدى لاعب</button>
          <button class="btn" onclick="goto('sec-xo')"><i class="fas fa-times"></i> XO اونلاين</button>
          <button class="btn" onclick="goto('sec-leaderboard')"><i class="fas fa-trophy"></i> المتصدرون</button>
          <button class="btn" onclick="goto('sec-store')"><i class="fas fa-shopping-bag"></i> المتجر</button>
          <button class="btn" onclick="goto('sec-profile')"><i class="fas fa-user"></i> ملفي</button>
        </div>
      </div>

      <div class="card">
        <h3>التحدي السريع</h3>
        <div style="display:flex;flex-direction:column;gap:12px;margin-top:12px">
          <div class="challenge-card">
            <div>
              <div style="font-weight:700">رد الفعل (Reaction)</div>
              <div class="small" style="color:var(--text-light)">اختبر سرعة نقرك</div>
            </div>
            <div>
              <span class="tag">+10 نقطة</span>
              <button class="btn small" onclick="startReaction()">ابدأ</button>
            </div>
          </div>

          <div class="challenge-card">
            <div>
              <div style="font-weight:700">اختبار سريع (Quiz)</div>
              <div class="small" style="color:var(--text-light)">أسئلة سريعة بصعوبة مختلفة</div>
            </div>
            <div>
              <span class="tag">+5 / +10 / +20</span>
              <button class="btn small" onclick="goto('sec-challenges')">ادخل التحديات</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Challenges Section -->
    <section id="sec-challenges">
      <div class="card">
        <h2>التحديات</h2>
        <p class="small" style="color:var(--text-light)">اختر نوع التحدي: كل مستوى يمنح نقاط مختلفة. يوجد مؤقت لكل سؤال.</p>
        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
          <button class="btn" onclick="startQuiz('easy')">أسئلة سهلة (+5)</button>
          <button class="btn" onclick="startQuiz('medium')">متوسطة (+10)</button>
          <button class="btn" onclick="startQuiz('hard')">صعبة (+20)</button>
          <button class="btn ghost" onclick="startRiddle()">ألغاز رياضية (+10)</button>
        </div>
      </div>

      <div id="challenge-area" class="card hidden"></div>
    </section>

    <!-- Battle Section -->
    <section id="sec-battle">
      <div class="card">
        <h2>تحدي لاعب ضد لاعب (1 vs 1)</h2>
        <p class="small" style="color:var(--text-light)">اختر لاعب من قائمة الأونلاين أو انشئ تحدي عامة</p>
        <div style="margin:12px 0">
          <div id="online-list"></div>
          <div style="margin-top:12px">
            <button class="btn" onclick="createPublicBattle()">إنشاء تحدي عام</button>
          </div>
        </div>
      </div>
    </section>

    <!-- XO Game Section -->
    <section id="sec-xo">
      <div class="card">
        <h2>لعبة XO اونلاين</h2>
        <p class="small" style="color:var(--text-light)">انضم إلى غرفة أو أنشئ غرفة جديدة للعب XO مع لاعبين آخرين</p>
        
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn" onclick="createXORoom()"><i class="fas fa-plus"></i> إنشاء غرفة</button>
          <button class="btn secondary" onclick="refreshXORooms()"><i class="fas fa-sync-alt"></i> تحديث الغرف</button>
        </div>
        
        <div class="xo-rooms" id="xo-rooms">
          <!-- XO rooms will be populated here -->
        </div>
      </div>
      
      <div id="xo-game-area" class="card hidden">
        <!-- XO game will be displayed here -->
      </div>
    </section>

    <!-- Leaderboard Section -->
    <section id="sec-leaderboard">
      <div class="card">
        <h2>المتصدرون</h2>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn small" onclick="renderLeaderboard('daily')">اليومي</button>
          <button class="btn small" onclick="renderLeaderboard('weekly')">الأسبوعي</button>
          <button class="btn small" onclick="renderLeaderboard('all')">كل الأوقات</button>
        </div>
        <div id="leaders-list" style="margin-top:16px"></div>
      </div>
    </section>

    <!-- Store Section -->
    <section id="sec-store">
      <div class="card">
        <h2>المتجر</h2>
        <p class="small" style="color:var(--text-light)">استخدم عملاتك لشراء عناصر رائعة</p>
        
        <div style="display:flex;align-items:center;gap:8px;margin-top:12px;padding:12px;background:var(--bg-card-light);border-radius:10px">
          <i class="fas fa-coins" style="color:var(--accent);font-size:20px"></i>
          <div style="flex-grow:1">
            <div style="font-size:12px;color:var(--text-muted)">رصيدك الحالي</div>
            <div style="font-weight:700;color:var(--accent)" id="store-coins">0 عملة</div>
          </div>
        </div>
        
        <div class="store-items">
          <div class="store-item">
            <div class="item-icon"><i class="fas fa-gem"></i></div>
            <div style="font-weight:700">إطار الماس</div>
            <div class="item-price">50 عملة</div>
            <button class="btn small" onclick="buyItem('diamond-frame')">شراء</button>
          </div>
          
          <div class="store-item">
            <div class="item-icon"><i class="fas fa-fire"></i></div>
            <div style="font-weight:700">شارة النار</div>
            <div class="item-price">30 عملة</div>
            <button class="btn small" onclick="buyItem('fire-badge')">شراء</button>
          </div>
          
          <div class="store-item">
            <div class="item-icon"><i class="fas fa-star"></i></div>
            <div style="font-weight:700">خلفية النجوم</div>
            <div class="item-price">75 عملة</div>
            <button class="btn small" onclick="buyItem('star-bg')">شراء</button>
          </div>
          
          <div class="store-item">
            <div class="item-icon"><i class="fas fa-bolt"></i></div>
            <div style="font-weight:700">تحدي مزدوج</div>
            <div class="item-price">40 عملة</div>
            <button class="btn small" onclick="buyItem('double-challenge')">شراء</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Profile Section -->
    <section id="sec-profile">
      <div class="card">
        <h2>الملف الشخصي</h2>
        <div class="profile-row">
          <img id="profile-img" class="profile-img" src="">
          <div style="flex-grow:1">
            <div id="profile-username" style="font-weight:800">ضيف</div>
            <div style="color:var(--text-light)">نقاط: <span id="profile-points">0</span> • مستوى: <span id="profile-level">0</span></div>
            <div class="badges" id="profile-badges"></div>
          </div>
          <div style="text-align: center; background: var(--bg-card-light); padding: 8px 12px; border-radius: 10px;">
            <div style="color: var(--accent); font-weight: 700; font-size: 18px;" id="profile-coins">0</div>
            <div style="font-size: 12px; color: var(--text-muted);"><i class="fas fa-coins"></i> عملات</div>
          </div>
        </div>

        <div style="margin-top:16px">
          <h4>العناصر المملوكة</h4>
          <div class="badges" id="profile-items">
            <!-- Owned items will appear here -->
          </div>
        </div>

        <div style="margin-top:16px">
          <h4>إحصائيات</h4>
          <div style="color:var(--text-light)">
            انتصارات: <span id="profile-wins">0</span> • خسائر: <span id="profile-losses">0</span> • إجمالي: <span id="profile-total">0</span>
          </div>
        </div>

        <div style="margin-top:16px;display:flex;gap:8px">
          <button class="btn" onclick="resetProfile()">إعادة ضبط الملف</button>
          <button class="btn ghost" onclick="exportProfile()">تصدير (نسخة)</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Navigation -->
  <nav class="bottom">
    <button id="nav-home" class="active" onclick="goto('sec-home')">
      <i class="fas fa-home"></i>
      <span>الرئيسية</span>
    </button>
    <button id="nav-challenges" onclick="goto('sec-challenges')">
      <i class="fas fa-bullseye"></i>
      <span>التحديات</span>
    </button>
    <button id="nav-battle" onclick="goto('sec-battle')">
      <i class="fas fa-fist-raised"></i>
      <span>معارك</span>
    </button>
    <button id="nav-xo" onclick="goto('sec-xo')">
      <i class="fas fa-times"></i>
      <span>XO</span>
    </button>
    <button id="nav-profile" onclick="goto('sec-profile')">
      <i class="fas fa-user"></i>
      <span>ملفي</span>
    </button>
  </nav>

  <!-- Modals & Notifications -->
  <div id="overlay" class="overlay hidden" style="display:none"></div>
  <div id="notify" class="notify"></div>

  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB3crsDcJI1qYipy6awM6VIoAamLC51zi4",
      authDomain: "cinmanryo.firebaseapp.com",
      databaseURL: "https://cinmanryo-default-rtdb.firebaseio.com",
      projectId: "cinmanryo",
      storageBucket: "cinmanryo.appspot.com",
      messagingSenderId: "605207743179",
      appId: "1:605207743179:web:0bb0b6efdd208e9094a94e",
      measurementId: "G-SH32EZ7ZY6"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();
    
    // Game state and variables
    let me = null;
    let presenceRef = null;
    let presenceInterval = null;
    let currentBattleId = null;
    let currentXORoom = null;
    let currentQuiz = null;
    let currentQuestionIndex = 0;
    
    // Database nodes
    const usersNode = 'users';
    const battlesNode = 'battles';
    const presenceNode = 'presence';
    const pointsHistoryNode = 'pointsHistory';
    const xoRoomsNode = 'xoRooms';
    const storeNode = 'store';
    const inventoryNode = 'inventory';
    
    // DOM utility functions
    const $ = (id) => document.getElementById(id);
    
    // Utility functions
    const nowTs = () => Date.now();
    const todayStart = () => {
      let d = new Date();
      d.setHours(0, 0, 0, 0);
      return d.getTime();
    };
    
    const weekStart = () => {
      let d = new Date();
      let day = d.getDay();
      let diff = d.getDate() - day + (day === 0 ? -6 : 1);
      d.setDate(diff);
      d.setHours(0, 0, 0, 0);
      return d.getTime();
    };
    
    function showNotify(text, success = true) {
      const n = $('notify');
      n.style.background = success 
        ? 'linear-gradient(90deg, var(--secondary), #00a07a)' 
        : 'linear-gradient(90deg, var(--danger), #ff0055)';
      n.innerText = text;
      n.style.display = 'block';
      setTimeout(() => n.style.display = 'none', 2800);
    }
    
    function sanitizeName(name) {
      // Allow only letters, numbers, and limited symbols
      return name.replace(/[^a-zA-Z0-9\u0600-\u06FF\s_-]/g, '').trim();
    }
    
    // Initialize the app
    function init() {
      // Check for existing user session
      const localUser = localStorage.getItem('tahdak_user');
      if (localUser) {
        const userData = JSON.parse(localUser);
        loadUserFromFirebase(userData.name);
      }
      
      // Set up event listeners
      $('btn-start').addEventListener('click', registerUser);
      $('btn-guest').addEventListener('click', registerAsGuest);
      $('btn-sound-toggle').addEventListener('click', toggleSound);
      
      // Load leaderboard
      renderLeaderboard('all');
      
      // Load XO rooms
      refreshXORooms();
      
      // Set up real-time listeners
      setupRealtimeListeners();
    }
    
    // Set up real-time Firebase listeners
    function setupRealtimeListeners() {
      // Listen for online users
      db.ref(presenceNode).on('value', snapshot => {
        const presenceData = snapshot.val() || {};
        renderOnlineList(presenceData);
        
        // Update online count
        const onlineUsers = Object.values(presenceData).filter(user => user.online).length;
        $('online-count').innerHTML = `<i class="fas fa-wifi"></i> أونلاين: ${onlineUsers}`;
      });
      
      // Listen for user data changes
      db.ref(usersNode).on('value', snapshot => {
        const users = snapshot.val() || {};
        
        // Update current user data if logged in
        if (me) {
          const currentUserData = users[me.name];
          if (currentUserData) {
            me = { ...me, ...currentUserData };
            updateUI();
          }
        }
        
        // Update leaderboard
        renderLeaderboard('all');
      });
      
      // Listen for XO room changes
      db.ref(xoRoomsNode).on('value', snapshot => {
        const rooms = snapshot.val() || {};
        renderXORooms(rooms);
      });
      
      // Listen for battle changes
      if (currentBattleId) {
        db.ref(`${battlesNode}/${currentBattleId}`).on('value', snapshot => {
          const battleData = snapshot.val();
          if (battleData) {
            renderBattleContent(currentBattleId, battleData);
          }
        });
      }
    }
    
    // User registration and authentication
    async function registerUser() {
      const name = sanitizeName($('inp-name').value || '');
      const file = $('inp-photo').files[0];
      
      if (!name) {
        showNotify('يرجى إدخال اسم صالح', false);
        return;
      }
      
      // Validate username (only letters, numbers, and limited symbols)
      if (!/^[a-zA-Z0-9\u0600-\u06FF\s_-]+$/.test(name)) {
        showNotify('الاسم يمكن أن يحتوي فقط على أحرف وأرقام ومسافات', false);
        return;
      }
      
      showNotify('جاري التسجيل...', true);
      
      let photoUrl = '';
      if (file) {
        // Upload image to Firebase Storage
        try {
          const ref = storage.ref('profiles/' + Date.now() + '_' + file.name);
          const snap = await ref.put(file);
          photoUrl = await snap.ref.getDownloadURL();
        } catch (error) {
          console.error('Error uploading image:', error);
          showNotify('حدث خطأ في رفع الصورة', false);
          return;
        }
      } else {
        // Create default avatar
        photoUrl = `data:image/svg+xml;utf8,${encodeURIComponent(`
          <svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'>
            <rect fill='#202020' width='100%' height='100%'/>
            <text x='50%' y='50%' fill='#fff' font-size='36' text-anchor='middle' dominant-baseline='central'>${name.substring(0,2)}</text>
          </svg>
        `)}`;
      }
      
      await registerToFirebase(name, photoUrl);
    }
    
    async function registerAsGuest() {
      const name = 'ضيف' + Math.floor(Math.random() * 9000 + 1000);
      const photoUrl = `data:image/svg+xml;utf8,${encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'>
          <rect fill='#202020' width='100%' height='100%'/>
          <text x='50%' y='50%' fill='#fff' font-size='36' text-anchor='middle' dominant-baseline='central'>?</text>
        </svg>
      `)}`;
      
      await registerToFirebase(name, photoUrl);
    }
    
    async function registerToFirebase(name, photoUrl) {
      const key = sanitizeName(name);
      const userRef = db.ref(`${usersNode}/${key}`);
      const snapshot = await userRef.once('value');
      let userData = snapshot.val() || {
        name: key,
        photo: photoUrl,
        points: 0,
        coins: 0,
        wins: 0,
        losses: 0,
        level: 1,
        badges: [],
        items: [],
        lastLogin: 0
      };
      
      // Update photo if changed
      userData.photo = photoUrl;
      
      // Daily login bonus (if not logged in today)
      const lastLogin = userData.lastLogin || 0;
      const today = todayStart();
      if (lastLogin < today) {
        userData.coins = (userData.coins || 0) + 10;
        userData.points = (userData.points || 0) + 5;
        
        // Record points history
        await db.ref(`${pointsHistoryNode}/${key}`).push({
          pts: 5,
          ts: nowTs(),
          reason: 'daily-login'
        });
        
        showNotify('مكافأة تسجيل الدخول +5 نقاط و +10 عملات');
      }
      
      userData.lastLogin = nowTs();
      await userRef.set(userData);
      
      // Store user locally
      localStorage.setItem('tahdak_user', JSON.stringify({ name: key, photo: photoUrl }));
      me = userData;
      
      afterLogin();
    }
    
    function loadUserFromFirebase(username) {
      const key = sanitizeName(username);
      db.ref(`${usersNode}/${key}`).once('value')
        .then(snapshot => {
          const userData = snapshot.val();
          if (userData) {
            me = userData;
            afterLogin();
          }
        })
        .catch(error => {
          console.error('Error loading user:', error);
        });
    }
    
    function afterLogin() {
      // Update UI with user data
      updateUI();
      
      // Hide login section, show home section
      $('sec-login').style.display = 'none';
      goto('sec-home');
      
      // Set up presence
      setPresence(true);
      
      // Update header
      $('header-sub').textContent = `مرحبا ${me.name}`;
    }
    
    function updateUI() {
      if (!me) return;
      
      // Update profile elements
      $('me-photo').src = me.photo;
      $('me-name').textContent = me.name;
      $('me-points').textContent = me.points || 0;
      $('me-level').textContent = me.level || 1;
      $('me-coins').textContent = me.coins || 0;
      
      $('profile-img').src = me.photo;
      $('profile-username').textContent = me.name;
      $('profile-points').textContent = me.points || 0;
      $('profile-level').textContent = me.level || 1;
      $('profile-coins').textContent = me.coins || 0;
      
      $('store-coins').textContent = `${me.coins || 0} عملة`;
      
      // Update stats
      $('stat-wins').textContent = me.wins || 0;
      $('stat-losses').textContent = me.losses || 0;
      $('stat-total').textContent = (me.wins || 0) + (me.losses || 0);
      
      $('profile-wins').textContent = me.wins || 0;
      $('profile-losses').textContent = me.losses || 0;
      $('profile-total').textContent = (me.wins || 0) + (me.losses || 0);
      
      // Render badges
      renderBadges();
      
      // Render owned items
      renderOwnedItems();
    }
    
    function renderBadges() {
      const badgesContainer = $('me-badges');
      const profileBadgesContainer = $('profile-badges');
      
      badgesContainer.innerHTML = '';
      profileBadgesContainer.innerHTML = '';
      
      if (me.badges && me.badges.length > 0) {
        me.badges.forEach(badge => {
          const badgeElement = document.createElement('div');
          badgeElement.className = 'badge';
          badgeElement.textContent = badge;
          
          badgesContainer.appendChild(badgeElement.cloneNode(true));
          profileBadgesContainer.appendChild(badgeElement);
        });
      }
    }
    
    function renderOwnedItems() {
      const itemsContainer = $('profile-items');
      itemsContainer.innerHTML = '';
      
      if (me.items && me.items.length > 0) {
        me.items.forEach(item => {
          const itemElement = document.createElement('div');
          itemElement.className = 'badge';
          itemElement.style.background = 'linear-gradient(90deg, var(--secondary), #00a07a)';
          itemElement.textContent = item;
          
          itemsContainer.appendChild(itemElement);
        });
      } else {
        itemsContainer.innerHTML = '<div style="color: var(--text-muted); font-size: 14px;">لا توجد عناصر مملوكة</div>';
      }
    }
    
    // Presence management
    function setPresence(online) {
      if (!me) return;
      
      const key = sanitizeName(me.name);
      presenceRef = db.ref(`${presenceNode}/${key}`);
      
      if (online) {
        presenceRef.set({
          online: true,
          lastActive: nowTs(),
          name: me.name,
          photo: me.photo
        });
        
        // Set up disconnect handler
        presenceRef.onDisconnect().set({
          online: false,
          lastActive: nowTs()
        });
        
        // Update presence periodically
        presenceInterval = setInterval(() => {
          presenceRef.update({
            online: true,
            lastActive: nowTs()
          });
        }, 20000);
      } else {
        if (presenceInterval) {
          clearInterval(presenceInterval);
        }
        presenceRef.set({
          online: false,
          lastActive: nowTs()
        });
      }
    }
    
    function renderOnlineList(presenceData) {
      const container = $('online-list');
      container.innerHTML = '';
      
      const onlineUsers = Object.values(presenceData)
        .filter(user => user.online)
        .sort((a, b) => (b.lastActive || 0) - (a.lastActive || 0));
      
      if (onlineUsers.length === 0) {
        container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">لا يوجد لاعبين متصلين حالياً</div>';
        return;
      }
      
      onlineUsers.forEach(user => {
        // Don't show current user in the list
        if (me && user.name === me.name) return;
        
        const userElement = document.createElement('div');
        userElement.className = 'leader-item';
        userElement.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px;">
            <img src="${user.photo}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
            <div>
              <strong>${user.name}</strong>
              <div style="color: var(--secondary); font-size: 12px;">أونلاين</div>
            </div>
          </div>
          <div>
            <button class="btn small" onclick="challengePlayer('${user.name}')">تحدي</button>
          </div>
        `;
        
        container.appendChild(userElement);
      });
    }
    
    // Navigation
    function goto(sectionId) {
      // Hide all sections
      document.querySelectorAll('section').forEach(section => {
        section.style.display = 'none';
      });
      
      // Show target section
      $(sectionId).style.display = 'block';
      
      // Update active nav button
      document.querySelectorAll('nav.bottom button').forEach(button => {
        button.classList.remove('active');
      });
      
      // Set the corresponding nav button as active
      switch(sectionId) {
        case 'sec-home':
          $('nav-home').classList.add('active');
          break;
        case 'sec-challenges':
          $('nav-challenges').classList.add('active');
          break;
        case 'sec-battle':
          $('nav-battle').classList.add('active');
          break;
        case 'sec-xo':
          $('nav-xo').classList.add('active');
          break;
        case 'sec-leaderboard':
          $('nav-leader').classList.add('active');
          break;
        case 'sec-profile':
          $('nav-profile').classList.add('active');
          break;
      }
    }
    
    // Points and coins system
    async function addPoints(userKey, points, reason = 'points', meta = {}) {
      const key = sanitizeName(userKey);
      const userRef = db.ref(`${usersNode}/${key}`);
      const snapshot = await userRef.once('value');
      const userData = snapshot.val() || {
        name: key,
        points: 0,
        coins: 0,
        wins: 0,
        losses: 0,
        level: 1,
        badges: [],
        items: []
      };
      
      // Update points and level
      userData.points = (userData.points || 0) + points;
      userData.level = 1 + Math.floor((userData.points || 0) / 100);
      
      // Update coins if specified in meta
      if (meta.coins) {
        userData.coins = (userData.coins || 0) + meta.coins;
      }
      
      // Update wins/losses if specified
      const updates = {
        points: userData.points,
        level: userData.level,
        coins: userData.coins
      };
      
      if (meta.wins) {
        updates.wins = (userData.wins || 0) + meta.wins;
      }
      
      if (meta.losses) {
        updates.losses = (userData.losses || 0) + meta.losses;
      }
      
      await userRef.update(updates);
      
      // Record points history
      await db.ref(`${pointsHistoryNode}/${key}`).push({
        pts: points,
        ts: nowTs(),
        reason: reason
      });
      
      // Update local user data if it's the current user
      if (me && sanitizeName(me.name) === key) {
        me.points = userData.points;
        me.level = userData.level;
        me.coins = userData.coins;
        
        if (meta.wins) me.wins = (me.wins || 0) + meta.wins;
        if (meta.losses) me.losses = (me.losses || 0) + meta.losses;
        
        updateUI();
      }
    }
    
    async function addCoins(userKey, coins, reason = 'coins') {
      await addPoints(userKey, 0, reason, { coins });
    }
    
    // Leaderboard
    async function renderLeaderboard(period = 'all') {
      const list = $('leaders-list');
      list.innerHTML = '<div class="small" style="color: var(--text-muted); text-align: center; padding: 20px;">جارٍ التحميل...</div>';
      
      try {
        let leaders = [];
        
        if (period === 'all') {
          // Get all users with at least 100 points
          const snapshot = await db.ref(usersNode).orderByChild('points').limitToLast(100).once('value');
          const users = snapshot.val() || {};
          
          leaders = Object.values(users)
            .filter(user => user.points >= 100) // Only users with 100+ points
            .sort((a, b) => (b.points || 0) - (a.points || 0))
            .slice(0, 10);
        } else {
          // For daily/weekly, we would need to calculate points from history
          // This is a simplified version
          const snapshot = await db.ref(usersNode).orderByChild('points').limitToLast(100).once('value');
          const users = snapshot.val() || {};
          
          leaders = Object.values(users)
            .filter(user => user.points >= 100)
            .sort((a, b) => (b.points || 0) - (a.points || 0))
            .slice(0, 10);
        }
        
        if (leaders.length === 0) {
          list.innerHTML = '<div class="small" style="color: var(--text-muted); text-align: center; padding: 20px;">لا يوجد لاعبين بعد</div>';
          return;
        }
        
        list.innerHTML = leaders.map((user, index) => {
          let crown = '';
          if (index === 0) crown = '<i class="fas fa-crown" style="color: var(--accent)"></i>';
          else if (index === 1) crown = '<i class="fas fa-medal" style="color: silver"></i>';
          else if (index === 2) crown = '<i class="fas fa-medal" style="color: #cd7f32"></i>';
          
          return `
            <div class="leader-item">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span class="crown">${crown}</span>
                <img src="${user.photo}" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">
                <div>
                  <strong>${user.name}</strong>
                  <div style="color: var(--text-muted); font-size: 12px;">المستوى ${user.level || 1}</div>
                </div>
              </div>
              <div style="text-align: left;">
                <div style="font-weight: 700; color: var(--primary);">${user.points || 0}</div>
                <div style="font-size: 12px; color: var(--text-muted);">نقطة</div>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading leaderboard:', error);
        list.innerHTML = '<div class="small" style="color: var(--danger); text-align: center; padding: 20px;">حدث خطأ في تحميل المتصدرين</div>';
      }
    }
    
    // Store functionality
    async function buyItem(itemId) {
      if (!me) {
        showNotify('يجب تسجيل الدخول أولاً', false);
        return;
      }
      
      const itemPrices = {
        'diamond-frame': 50,
        'fire-badge': 30,
        'star-bg': 75,
        'double-challenge': 40
      };
      
      const price = itemPrices[itemId];
      
      if (!price) {
        showNotify('العنصر غير موجود', false);
        return;
      }
      
      if (me.coins < price) {
        showNotify('رصيدك غير كافي لشراء هذا العنصر', false);
        return;
      }
      
      // Check if user already owns the item
      if (me.items && me.items.includes(itemId)) {
        showNotify('أنت تمتلك هذا العنصر مسبقاً', false);
        return;
      }
      
      // Deduct coins and add item to inventory
      const userRef = db.ref(`${usersNode}/${me.name}`);
      const updates = {
        coins: me.coins - price
      };
      
      // Add item to user's inventory
      const userItems = me.items || [];
      userItems.push(itemId);
      updates.items = userItems;
      
      await userRef.update(updates);
      
      // Update local user data
      me.coins = me.coins - price;
      me.items = userItems;
      
      updateUI();
      showNotify(`تم شراء العنصر بنجاح!`, true);
    }
    
    // XO Game functionality
    function createXORoom() {
      if (!me) {
        showNotify('يجب تسجيل الدخول أولاً', false);
        return;
      }
      
      const roomId = 'room_' + Math.random().toString(36).substring(2, 9);
      const roomRef = db.ref(`${xoRoomsNode}/${roomId}`);
      
      const roomData = {
        id: roomId,
        host: me.name,
        hostPhoto: me.photo,
        players: [me.name],
        board: ['', '', '', '', '', '', '', '', ''],
        currentPlayer: 'X',
        status: 'waiting', // waiting, playing, finished
        winner: null,
        createdAt: nowTs()
      };
      
      roomRef.set(roomData);
      showNotify('تم إنشاء غرفة XO جديدة', true);
      
      // Join the room
      joinXORoom(roomId);
    }
    
    function refreshXORooms() {
      db.ref(xoRoomsNode).once('value')
        .then(snapshot => {
          const rooms = snapshot.val() || {};
          renderXORooms(rooms);
        })
        .catch(error => {
          console.error('Error loading XO rooms:', error);
        });
    }
    
    function renderXORooms(rooms) {
      const container = $('xo-rooms');
      container.innerHTML = '';
      
      const roomList = Object.values(rooms)
        .filter(room => room.status === 'waiting' || room.status === 'playing')
        .sort((a, b) => b.createdAt - a.createdAt);
      
      if (roomList.length === 0) {
        container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">لا توجد غرف متاحة حالياً</div>';
        return;
      }
      
      roomList.forEach(room => {
        const roomElement = document.createElement('div');
        roomElement.className = 'xo-room';
        
        const playerCount = room.players ? room.players.length : 0;
        const maxPlayers = 2;
        
        roomElement.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px;">
            <img src="${room.hostPhoto}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
            <div>
              <strong>غرفة ${room.id.substring(0, 6)}</strong>
              <div style="color: var(--text-muted); font-size: 12px;">أنشأها ${room.host}</div>
            </div>
          </div>
          <div style="text-align: left;">
            <div style="font-size: 12px; color: var(--text-muted);">${playerCount}/${maxPlayers} لاعبين</div>
            <button class="btn small" onclick="joinXORoom('${room.id}')">${room.status === 'waiting' ? 'انضم' : 'شاهد'}</button>
          </div>
        `;
        
        container.appendChild(roomElement);
      });
    }
    
    function joinXORoom(roomId) {
      if (!me) {
        showNotify('يجب تسجيل الدخول أولاً', false);
        return;
      }
      
      const roomRef = db.ref(`${xoRoomsNode}/${roomId}`);
      
      roomRef.once('value')
        .then(snapshot => {
          const room = snapshot.val();
          if (!room) {
            showNotify('الغرفة لم تعد موجودة', false);
            return;
          }
          
          // Check if room is full
          if (room.players && room.players.length >= 2 && !room.players.includes(me.name)) {
            showNotify('الغرفة ممتلئة', false);
            return;
          }
          
          // Join the room if not already joined
          if (!room.players.includes(me.name)) {
            const updatedPlayers = [...room.players, me.name];
            roomRef.update({
              players: updatedPlayers,
              status: updatedPlayers.length === 2 ? 'playing' : 'waiting'
            });
          }
          
          // Set current room and show game
          currentXORoom = roomId;
          showXOGame(roomId);
        })
        .catch(error => {
          console.error('Error joining XO room:', error);
          showNotify('حدث خطأ في الانضمام للغرفة', false);
        });
    }
    
    function showXOGame(roomId) {
      const gameArea = $('xo-game-area');
      gameArea.classList.remove('hidden');
      
      // Listen for room changes
      const roomRef = db.ref(`${xoRoomsNode}/${roomId}`);
      roomRef.on('value', snapshot => {
        const room = snapshot.val();
        if (!room) {
          gameArea.innerHTML = '<div style="color: var(--danger); text-align: center; padding: 20px;">الغرفة لم تعد موجودة</div>';
          return;
        }
        
        renderXOGame(room);
      });
    }
    
    function renderXOGame(room) {
      const gameArea = $('xo-game-area');
      
      // Determine player symbol
      const playerIndex = room.players.indexOf(me.name);
      const playerSymbol = playerIndex === 0 ? 'X' : 'O';
      
      gameArea.innerHTML = `
        <h3>غرفة ${room.id.substring(0, 6)}</h3>
        <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <img src="${room.hostPhoto}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
            <span style="font-weight: 700; color: ${room.currentPlayer === 'X' ? 'var(--primary)' : 'var(--text-muted)'};">${room.host} (X)</span>
          </div>
          <div style="font-weight: 700; color: var(--accent);">VS</div>
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-weight: 700; color: ${room.currentPlayer === 'O' ? 'var(--secondary)' : 'var(--text-muted)'};">${room.players[1] || 'بانتظار لاعب...'} (O)</span>
            ${room.players[1] ? `<img src="${getPlayerPhoto(room.players[1])}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">` : ''}
          </div>
        </div>
        
        ${room.status === 'finished' ? `
          <div style="text-align: center; margin: 15px 0; padding: 10px; background: var(--bg-card-light); border-radius: 10px;">
            <h4>${room.winner ? `فاز ${room.winner === 'X' ? room.host : room.players[1]}!` : 'تعادل!'}</h4>
            <button class="btn" onclick="leaveXORoom()">مغادرة الغرفة</button>
          </div>
        ` : ''}
        
        <div class="xo-board">
          ${room.board.map((cell, index) => `
            <div class="xo-cell ${cell ? (cell === 'X' ? 'x' : 'o') : ''}" 
                 onclick="makeXOMove(${index})"
                 style="${room.status !== 'playing' || room.currentPlayer !== playerSymbol || cell ? 'pointer-events: none;' : ''}">
              ${cell === 'X' ? '<i class="fas fa-times"></i>' : cell === 'O' ? '<i class="far fa-circle"></i>' : ''}
            </div>
          `).join('')}
        </div>
        
        <div style="text-align: center; margin-top: 15px;">
          <div style="color: var(--text-muted); font-size: 14px;">
            ${room.status === 'waiting' ? 'بانتظار لاعب آخر...' : 
              room.status === 'playing' ? `دور ${room.currentPlayer === 'X' ? room.host : room.players[1]}` : ''}
          </div>
          <button class="btn ghost small" onclick="leaveXORoom()" style="margin-top: 10px;">مغادرة الغرفة</button>
        </div>
      `;
    }
    
    function getPlayerPhoto(playerName) {
      // In a real app, we would fetch this from the users node
      // For now, return a default
      return `data:image/svg+xml;utf8,${encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'>
          <rect fill='#202020' width='100%' height='100%'/>
          <text x='50%' y='50%' fill='#fff' font-size='36' text-anchor='middle' dominant-baseline='central'>${playerName.substring(0,2)}</text>
        </svg>
      `)}`;
    }
    
    function makeXOMove(cellIndex) {
      if (!currentXORoom || !me) return;
      
      const roomRef = db.ref(`${xoRoomsNode}/${currentXORoom}`);
      
      roomRef.once('value')
        .then(snapshot => {
          const room = snapshot.val();
          if (!room || room.status !== 'playing') return;
          
          // Determine player symbol
          const playerIndex = room.players.indexOf(me.name);
          const playerSymbol = playerIndex === 0 ? 'X' : 'O';
          
          // Check if it's the player's turn
          if (room.currentPlayer !== playerSymbol) return;
          
          // Check if cell is empty
          if (room.board[cellIndex] !== '') return;
          
          // Update board
          const newBoard = [...room.board];
          newBoard[cellIndex] = playerSymbol;
          
          // Check for winner
          const winner = checkXOWinner(newBoard);
          const isBoardFull = newBoard.every(cell => cell !== '');
          
          // Update room
          const updates = {
            board: newBoard,
            currentPlayer: playerSymbol === 'X' ? 'O' : 'X'
          };
          
          if (winner) {
            updates.status = 'finished';
            updates.winner = winner;
            
            // Award coins to winner
            const winnerName = winner === 'X' ? room.players[0] : room.players[1];
            addCoins(winnerName, 25, 'xo-win');
            addPoints(winnerName, 10, 'xo-win', { wins: 1 });
            
            // Update loser stats
            const loserName = winner === 'X' ? room.players[1] : room.players[0];
            if (loserName) {
              addPoints(loserName, 0, 'xo-lose', { losses: 1 });
            }
          } else if (isBoardFull) {
            updates.status = 'finished';
            updates.winner = null;
            
            // Award coins to both players for draw
            room.players.forEach(player => {
              addCoins(player, 10, 'xo-draw');
            });
          }
          
          roomRef.update(updates);
        })
        .catch(error => {
          console.error('Error making XO move:', error);
        });
    }
    
    function checkXOWinner(board) {
      const winPatterns = [
        [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
        [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
        [0, 4, 8], [2, 4, 6]             // Diagonals
      ];
      
      for (const pattern of winPatterns) {
        const [a, b, c] = pattern;
        if (board[a] && board[a] === board[b] && board[a] === board[c]) {
          return board[a];
        }
      }
      
      return null;
    }
    
    function leaveXORoom() {
      if (currentXORoom) {
        const roomRef = db.ref(`${xoRoomsNode}/${currentXORoom}`);
        roomRef.off(); // Remove listener
        
        // Remove player from room
        roomRef.once('value')
          .then(snapshot => {
            const room = snapshot.val();
            if (room && room.players) {
              const updatedPlayers = room.players.filter(player => player !== me.name);
              
              if (updatedPlayers.length === 0) {
                // Delete room if empty
                roomRef.remove();
              } else {
                // Update room
                roomRef.update({
                  players: updatedPlayers,
                  status: updatedPlayers.length === 1 ? 'waiting' : room.status
                });
              }
            }
          })
          .catch(error => {
            console.error('Error leaving XO room:', error);
          });
        
        currentXORoom = null;
      }
      
      $('xo-game-area').classList.add('hidden');
      refreshXORooms();
    }
    
    // Battle system (simplified for this example)
    function challengePlayer(playerName) {
      if (!me) {
        showNotify('يجب تسجيل الدخول أولاً', false);
        return;
      }
      
      showNotify(`تم إرسال تحدي إلى ${playerName}`, true);
      // In a full implementation, this would create a battle room
    }
    
    function createPublicBattle() {
      if (!me) {
        showNotify('يجب تسجيل الدخول أولاً', false);
        return;
      }
      
      showNotify('تم إنشاء تحدي عام', true);
      // In a full implementation, this would create a public battle room
    }
    
    // Quiz system
    const quizBank = {
      easy: [
        { q: "ما هو لون السماء صافياً؟", choices: ["أخضر", "أزرق", "أحمر", "أسود"], a: 1 },
        { q: "كم عدد أيام الأسبوع؟", choices: ["5", "6", "7", "8"], a: 2 },
        { q: "ما هو أكبر كوكب في النظام الشمسي؟", choices: ["الأرض", "المشتري", "زحل", "المريخ"], a: 1 }
      ],
      medium: [
        { q: "عاصمة اليابان؟", choices: ["بكين", "طوكيو", "سيول", "بانكوك"], a: 1 },
        { q: "كم جانب للمكعب؟", choices: ["4", "6", "8", "12"], a: 1 },
        { q: "ما هو العنصر الكيميائي للرمز 'O'؟", choices: ["ذهب", "فضة", "أكسجين", "أوزميوم"], a: 2 }
      ],
      hard: [
        { q: "ما هو مجموع الزوايا الداخلية لمثلث؟", choices: ["180", "360", "90", "270"], a: 0 },
        { q: "ما هو العدد الأولي التالي بعد 7؟", choices: ["9", "10", "11", "12"], a: 2 },
        { q: "في أي سنة هبط الإنسان على القمر لأول مرة؟", choices: ["1965", "1969", "1972", "1958"], a: 1 }
      ],
      riddles: [
        { q: "إذا كان لديك 3 تفاحات وأخذت 2، كم لديك؟", answer: "2" },
        { q: "ما هو الشيء الذي يملك أسنان لكنه لا يعض؟", answer: "المشط" }
      ]
    };
    
    function startQuiz(level) {
      if (!me) {
        showNotify('يجب تسجيل الدخول أولاً', false);
        return;
      }
      
      const bank = quizBank[level] || quizBank.easy;
      const questions = [...bank].sort(() => 0.5 - Math.random()).slice(0, 5); // Pick 5 random questions
      
      currentQuiz = {
        type: 'quiz',
        level,
        questions,
        currentQuestionIndex: 0,
        score: 0,
        startTime: nowTs()
      };
      
      showQuizQuestion();
    }
    
    function showQuizQuestion() {
      if (!currentQuiz) return;
      
      const question = currentQuiz.questions[currentQuiz.currentQuestionIndex];
      const area = $('challenge-area');
      
      area.classList.remove('hidden');
      area.innerHTML = `
        <div class="quiz-container">
          <div class="progress-bar">
            <div class="progress" style="width: ${((currentQuiz.currentQuestionIndex + 1) / currentQuiz.questions.length) * 100}%"></div>
          </div>
          <div class="quiz-question">${question.q}</div>
          <div class="quiz-options">
            ${question.choices.map((choice, index) => `
              <div class="quiz-option" onclick="submitQuizAnswer(${index})">${choice}</div>
            `).join('')}
          </div>
          <div style="margin-top: 15px; color: var(--text-muted); font-size: 14px;">
            السؤال ${currentQuiz.currentQuestionIndex + 1} من ${currentQuiz.questions.length}
          </div>
        </div>
      `;
    }
    
    function submitQuizAnswer(answerIndex) {
      if (!currentQuiz) return;
      
      const question = currentQuiz.questions[currentQuiz.currentQuestionIndex];
      const isCorrect = answerIndex === question.a;
      
      // Show feedback
      const options = document.querySelectorAll('.quiz-option');
      options.forEach((option, index) => {
        if (index === question.a) {
          option.classList.add('correct');
        } else if (index === answerIndex && !isCorrect) {
          option.classList.add('incorrect');
        }
        option.style.pointerEvents = 'none';
      });
      
      if (isCorrect) {
        currentQuiz.score++;
      }
      
      // Move to next question after a delay
      setTimeout(() => {
        currentQuiz.currentQuestionIndex++;
        
        if (currentQuiz.currentQuestionIndex < currentQuiz.questions.length) {
          showQuizQuestion();
        } else {
          finishQuiz();
        }
      }, 1500);
    }
    
    function finishQuiz() {
      if (!currentQuiz) return;
      
      const area = $('challenge-area');
      const points = currentQuiz.level === 'easy' ? 5 : currentQuiz.level === 'medium' ? 10 : 20;
      const totalPoints = currentQuiz.score * points;
      
      area.innerHTML = `
        <div class="quiz-container">
          <h3>انتهى الاختبار!</h3>
          <div style="font-size: 48px; color: var(--primary); margin: 20px 0;">${currentQuiz.score}/${currentQuiz.questions.length}</div>
          <div style="color: var(--text-light); margin-bottom: 20px;">
            لقد كسبت <span style="color: var(--accent); font-weight: 700;">${totalPoints} نقطة</span> و <span style="color: var(--accent); font-weight: 700;">${totalPoints} عملة</span>
          </div>
          <button class="btn" onclick="$('challenge-area').classList.add('hidden');">تم</button>
        </div>
      `;
      
      // Award points and coins
      addPoints(me.name, totalPoints, `quiz-${currentQuiz.level}`);
      addCoins(me.name, totalPoints, `quiz-${currentQuiz.level}`);
      
      // Award badge if perfect score
      if (currentQuiz.score === currentQuiz.questions.length) {
        awardBadge(me.name, 'خبير المسابقات');
      }
      
      currentQuiz = null;
    }
    
    function startRiddle() {
      if (!me) {
        showNotify('يجب تسجيل الدخول أولاً', false);
        return;
      }
      
      const bank = quizBank.riddles;
      const riddle = bank[Math.floor(Math.random() * bank.length)];
      
      const area = $('challenge-area');
      area.classList.remove('hidden');
      area.innerHTML = `
        <div class="quiz-container">
          <div class="quiz-question">${riddle.q}</div>
          <input type="text" id="riddle-answer" placeholder="اكتب إجابتك هنا..." style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-dark); color: var(--text); margin: 15px 0;">
          <button class="btn" onclick="submitRiddleAnswer()">تحقق من الإجابة</button>
        </div>
      `;
    }
    
    function submitRiddleAnswer() {
      const answer = $('#riddle-answer').value.trim();
      const area = $('challenge-area');
      
      if (!answer) {
        showNotify('يرجى إدخال إجابة', false);
        return;
      }
      
      // In a real app, we would have a proper answer checking mechanism
      // For now, we'll assume the answer is correct
      area.innerHTML = `
        <div class="quiz-container">
          <h3 style="color: var(--success);">إجابة صحيحة!</h3>
          <div style="color: var(--text-light); margin: 20px 0;">
            لقد كسبت <span style="color: var(--accent); font-weight: 700;">10 نقاط</span> و <span style="color: var(--accent); font-weight: 700;">10 عملات</span>
          </div>
          <button class="btn" onclick="$('challenge-area').classList.add('hidden');">تم</button>
        </div>
      `;
      
      // Award points and coins
      addPoints(me.name, 10, 'riddle');
      addCoins(me.name, 10, 'riddle');
      
      // Award badge
      awardBadge(me.name, 'حلال الألغاز');
    }
    
    function startReaction() {
      if (!me) {
        showNotify('يجب تسجيل الدخول أولاً', false);
        return;
      }
      
      const area = $('challenge-area');
      area.classList.remove('hidden');
      area.innerHTML = `
        <div class="center">
          <div id="reaction-box" style="padding: 60px; border-radius: 12px; background: var(--bg-card-light); margin-bottom: 15px; cursor: pointer; font-size: 24px; font-weight: 700;">
            اضغط عندما يتغير اللون!
          </div>
          <div id="reaction-result" class="small" style="color: var(--text-light);"></div>
        </div>
      `;
      
      const box = $('#reaction-box');
      const waitTime = Math.floor(Math.random() * 3000) + 1000;
      
      setTimeout(() => {
        box.style.background = 'linear-gradient(90deg, var(--primary), var(--primary-dark))';
        box.textContent = 'اضغط الآن!';
        box.style.color = 'white';
        
        const startTime = nowTs();
        box.onclick = () => {
          const reactionTime = nowTs() - startTime;
          box.onclick = null;
          
          let points = 0;
          if (reactionTime < 250) points = 20;
          else if (reactionTime < 500) points = 10;
          else points = 5;
          
          $('#reaction-result').innerHTML = `
            زمن رد فعلك: <span style="color: var(--accent); font-weight: 700;">${reactionTime} مللي ثانية</span><br>
            ربحت <span style="color: var(--accent); font-weight: 700;">${points} نقاط</span> و <span style="color: var(--accent); font-weight: 700;">${points} عملات</span>
          `;
          
          box.style.pointerEvents = 'none';
          box.textContent = 'انتهى التحدي!';
          
          // Award points and coins
          addPoints(me.name, points, 'reaction');
          addCoins(me.name, points, 'reaction');
          
          // Award badge for fast reaction
          if (reactionTime < 200) {
            awardBadge(me.name, 'رد فعل سريع');
          }
        };
      }, waitTime);
    }
    
    // Badge system
    async function awardBadge(userKey, badgeName) {
      const key = sanitizeName(userKey);
      const userRef = db.ref(`${usersNode}/${key}`);
      const snapshot = await userRef.once('value');
      const userData = snapshot.val() || {};
      
      const badges = userData.badges || [];
      if (!badges.includes(badgeName)) {
        badges.push(badgeName);
        await userRef.update({ badges });
        
        // Update local data
        if (me && me.name === key) {
          me.badges = badges;
          renderBadges();
        }
        
        showNotify(`مبروك! لقد ربحت وسام ${badgeName}`, true);
      }
    }
    
    // Utility functions
    function toggleSound() {
      const btn = $('btn-sound-toggle');
      const isOn = btn.innerHTML.includes('volume-up');
      
      if (isOn) {
        btn.innerHTML = '<i class="fas fa-volume-mute"></i> صوت';
      } else {
        btn.innerHTML = '<i class="fas fa-volume-up"></i> صوت';
      }
    }
    
    function resetProfile() {
      if (!me) return;
      
      if (confirm('هل تريد إعادة ضبط بيانات ملفك؟ (سيتم حذف النقاط والأوسمة محليًا وعلى Firebase)')) {
        const key = sanitizeName(me.name);
        const defaultData = {
          name: key,
          photo: me.photo,
          points: 0,
          coins: 0,
          wins: 0,
          losses: 0,
          level: 1,
          badges: [],
          items: [],
          lastLogin: nowTs()
        };
        
        db.ref(`${usersNode}/${key}`).set(defaultData);
        db.ref(`${pointsHistoryNode}/${key}`).remove();
        
        showNotify('تمت إعادة الضبط');
      }
    }
    
    function exportProfile() {
      if (!me) return;
      
      const data = JSON.stringify(me, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${me.name}_profile.json`;
      a.click();
    }
    
    // Initialize the application
    window.addEventListener('load', init);
    
    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      if (presenceRef) {
        setPresence(false);
      }
      
      if (currentXORoom) {
        leaveXORoom();
      }
    });
  </script>
</body>
</html>
